"use strict";(self.webpackChunkopen_catalogi_docs=self.webpackChunkopen_catalogi_docs||[]).push([[3043],{28453:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>c});var r=t(96540);const i={},s=r.createContext(i);function a(e){const n=r.useContext(s);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),r.createElement(s.Provider,{value:n},e.children)}},62288:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>c,default:()=>p,frontMatter:()=>a,metadata:()=>r,toc:()=>o});const r=JSON.parse('{"id":"development/rag-fix","title":"RAG Semantic Search Fix","description":"\u2705 FIXED ISSUES","source":"@site/docs/development/rag-fix.md","sourceDirName":"development","slug":"/development/rag-fix","permalink":"/docs/development/rag-fix","draft":false,"unlisted":false,"editUrl":"https://github.com/conductionnl/openregister/tree/main/website/docs/development/rag-fix.md","tags":[],"version":"current","sidebarPosition":75,"frontMatter":{"title":"RAG Semantic Search Fix","sidebar_position":75},"sidebar":"tutorialSidebar","previous":{"title":"Search and Faceting Optimization","permalink":"/docs/development/search-optimization"},"next":{"title":"LLPhant Refactoring Plan","permalink":"/docs/development/llphant-refactor"}}');var i=t(74848),s=t(28453);const a={title:"RAG Semantic Search Fix",sidebar_position:75},c="RAG Semantic Search - Fix Summary",l={},o=[{value:"\u2705 FIXED ISSUES",id:"-fixed-issues",level:2},{value:"1. Critical Bug: Wrong Parameter Type to semanticSearch()",id:"1-critical-bug-wrong-parameter-type-to-semanticsearch",level:3},{value:"2. fetchVectors() Didn&#39;t Support Array Filters",id:"2-fetchvectors-didnt-support-array-filters",level:3},{value:"3. extractSourceName() Didn&#39;t Check Metadata",id:"3-extractsourcename-didnt-check-metadata",level:3},{value:"Testing",id:"testing",level:2},{value:"Related Documentation",id:"related-documentation",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"rag-semantic-search---fix-summary",children:"RAG Semantic Search - Fix Summary"})}),"\n",(0,i.jsx)(n.h2,{id:"-fixed-issues",children:"\u2705 FIXED ISSUES"}),"\n",(0,i.jsx)(n.h3,{id:"1-critical-bug-wrong-parameter-type-to-semanticsearch",children:"1. Critical Bug: Wrong Parameter Type to semanticSearch()"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"File:"})," ",(0,i.jsx)(n.code,{children:"lib/Service/ChatService.php"})]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Problem:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",children:"// WRONG - Line 403:\n$results = $this->vectorService->semanticSearch(\n    $query,\n    $numSources * 2,\n    0.7  // \u2190 FLOAT passed instead of array!\n);\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Expected Signature:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",children:"public function semanticSearch(\n    string $query,\n    int $limit = 10,\n    array $filters = [],  // \u2190 Must be array!\n    ?string $provider = null\n): array\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Fix Applied:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",children:"// Build filters array based on agent settings\n$vectorFilters = [];\n$entityTypes = [];\nif ($includeObjects) $entityTypes[] = 'object';\nif ($includeFiles) $entityTypes[] = 'file';\nif (!empty($entityTypes) && count($entityTypes) < 2) {\n    $vectorFilters['entity_type'] = $entityTypes;\n}\n\n$results = $this->vectorService->semanticSearch(\n    $query,\n    $numSources * 2,\n    $vectorFilters  // \u2705 Correct array!\n);\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Impact:"})," This bug caused semantic search to ",(0,i.jsx)(n.strong,{children:"fail completely"}),', returning empty/invalid results, which is why chat showed "Unknown Source".']}),"\n",(0,i.jsx)(n.h3,{id:"2-fetchvectors-didnt-support-array-filters",children:"2. fetchVectors() Didn't Support Array Filters"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"File:"})," ",(0,i.jsx)(n.code,{children:"lib/Service/VectorEmbeddingService.php"})]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Problem:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",children:"// Only supported string comparison:\nif (isset($filters['entity_type'])) {\n    $qb->andWhere($qb->expr()->eq('entity_type', ...));  // Only =\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Fix Applied:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",children:"// Now supports both string and array:\nif (isset($filters['entity_type'])) {\n    if (is_array($filters['entity_type'])) {\n        $qb->andWhere($qb->expr()->in('entity_type', ...));  // IN clause\n    } else {\n        $qb->andWhere($qb->expr()->eq('entity_type', ...));  // = comparison\n    }\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Impact:"})," Now we can filter by multiple entity types: ",(0,i.jsx)(n.code,{children:"['object', 'file']"})]}),"\n",(0,i.jsx)(n.h3,{id:"3-extractsourcename-didnt-check-metadata",children:"3. extractSourceName() Didn't Check Metadata"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"File:"})," ",(0,i.jsx)(n.code,{children:"lib/Service/ChatService.php"})]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Problem:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",children:"// Only checked top-level fields, not metadata:\nif (!empty($result['entity_id'])) {\n    return ($result['entity_type'] ?? 'Item') . ' #' . $result['entity_id'];\n}\nreturn 'Unknown Source';  // \u2190 Always fell back to this!\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Fix Applied:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",children:"// Now checks metadata for object_title, file_name, etc:\nif (!empty($result['metadata'])) {\n    $metadata = is_array($result['metadata']) \n        ? $result['metadata'] \n        : json_decode($result['metadata'], true);\n    \n    if (!empty($metadata['object_title'])) return $metadata['object_title'];\n    if (!empty($metadata['file_name'])) return $metadata['file_name'];\n    // ... more fallbacks\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Impact:"}),' Source names now display correctly instead of "Unknown Source"']}),"\n",(0,i.jsx)(n.h2,{id:"testing",children:"Testing"}),"\n",(0,i.jsx)(n.p,{children:"After fixes, verify:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Semantic search returns results"}),"\n",(0,i.jsx)(n.li,{children:"Source names display correctly"}),"\n",(0,i.jsx)(n.li,{children:"Entity type filters work (objects only, files only, both)"}),"\n",(0,i.jsx)(n.li,{children:"Chat responses include proper source citations"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"related-documentation",children:"Related Documentation"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"/docs/development/performance-optimization",children:"Performance Optimization"})," - Performance improvements"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"/docs/technical/vectorization#vector-search-backends",children:"Vector Search Backends"})," - Vector search implementation"]}),"\n"]})]})}function p(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}}}]);