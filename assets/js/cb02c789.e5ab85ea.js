"use strict";(self.webpackChunkopen_catalogi_docs=self.webpackChunkopen_catalogi_docs||[]).push([[6465],{24775:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>o,contentTitle:()=>s,default:()=>h,frontMatter:()=>a,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"development/llphant-refactor","title":"LLPhant Refactoring Plan","description":"Current Problems","source":"@site/docs/development/llphant-refactor.md","sourceDirName":"development","slug":"/development/llphant-refactor","permalink":"/docs/development/llphant-refactor","draft":false,"unlisted":false,"editUrl":"https://github.com/conductionnl/openregister/tree/main/website/docs/development/llphant-refactor.md","tags":[],"version":"current","sidebarPosition":80,"frontMatter":{"title":"LLPhant Refactoring Plan","sidebar_position":80},"sidebar":"tutorialSidebar","previous":{"title":"RAG Semantic Search Fix","permalink":"/docs/development/rag-fix"},"next":{"title":"Text Extraction Refactoring Summary","permalink":"/docs/development/text-extraction-refactoring"}}');var i=t(74848),l=t(28453);const a={title:"LLPhant Refactoring Plan",sidebar_position:80},s="Refactoring Plan: Use LLPhant FileDataReader & DocumentSplitter",o={},c=[{value:"Current Problems",id:"current-problems",level:2},{value:"LLPhant Built-in Features",id:"llphant-built-in-features",level:2},{value:"FileDataReader",id:"filedatareader",level:3},{value:"DocumentSplitter",id:"documentsplitter",level:3},{value:"Proposed Refactoring",id:"proposed-refactoring",level:2},{value:"1. Remove Manual Document Extraction",id:"1-remove-manual-document-extraction",level:3},{value:"2. Update TextExtractionService",id:"2-update-textextractionservice",level:3},{value:"3. Add Chunking During Extraction",id:"3-add-chunking-during-extraction",level:3},{value:"Benefits",id:"benefits",level:2},{value:"Migration Steps",id:"migration-steps",level:2},{value:"Related Documentation",id:"related-documentation",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,l.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"refactoring-plan-use-llphant-filedatareader--documentsplitter",children:"Refactoring Plan: Use LLPhant FileDataReader & DocumentSplitter"})}),"\n",(0,i.jsx)(n.h2,{id:"current-problems",children:"Current Problems"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"No chunks being created"})," - Text is extracted and stored, but not chunked into database records"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Manual PDF/DOCX extraction"})," - We're using separate libraries (smalot/pdfparser, phpoffice/phpword)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Chunking happens in SOLR service"})," - Should happen during extraction"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Missing overlap support"})," - Current chunking doesn't use overlap parameter from settings"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"llphant-built-in-features",children:"LLPhant Built-in Features"}),"\n",(0,i.jsxs)(n.p,{children:["According to ",(0,i.jsx)(n.a,{href:"https://github.com/LLPhant/LLPhant?tab=readme-ov-file#read-data",children:"LLPhant documentation"}),":"]}),"\n",(0,i.jsx)(n.h3,{id:"filedatareader",children:"FileDataReader"}),"\n",(0,i.jsx)(n.p,{children:"Reads various file formats automatically:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"PDF"}),"\n",(0,i.jsx)(n.li,{children:"DOCX, PPTX"}),"\n",(0,i.jsx)(n.li,{children:"TXT, MD, HTML, JSON, XML, CSV"}),"\n",(0,i.jsx)(n.li,{children:"And more..."}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",children:"use LLPhant\\Embeddings\\DataReader\\FileDataReader;\n\n$reader = new FileDataReader($filePath, Document::class);\n$documents = $reader->getDocuments(); // Returns array of Document objects\n"})}),"\n",(0,i.jsx)(n.h3,{id:"documentsplitter",children:"DocumentSplitter"}),"\n",(0,i.jsx)(n.p,{children:"Splits documents into chunks with overlap support:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",children:'use LLPhant\\Embeddings\\DocumentSplitter\\DocumentSplitter;\n\n// Split with overlap!\n$splitDocuments = DocumentSplitter::splitDocuments(\n    $documents,\n    800,        // maxLength (chunk size)\n    "\\n",       // separator\n    100         // overlap (YES, supported!)\n);\n'})}),"\n",(0,i.jsx)(n.h2,{id:"proposed-refactoring",children:"Proposed Refactoring"}),"\n",(0,i.jsx)(n.h3,{id:"1-remove-manual-document-extraction",children:"1. Remove Manual Document Extraction"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Remove from composer.json:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'"smalot/pdfparser": "^2.9",\n"phpoffice/phpword": "^1.2"\n'})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Remove from TextExtractionService.php:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"extractPdf()"})," method"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"extractWord()"})," method"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"extractSpreadsheet()"})," method"]}),"\n",(0,i.jsx)(n.li,{children:"Import statements for those libraries"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"2-update-textextractionservice",children:"2. Update TextExtractionService"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"New approach:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",children:"use LLPhant\\Embeddings\\DataReader\\FileDataReader;\nuse LLPhant\\Embeddings\\DocumentSplitter\\DocumentSplitter;\n\nprivate function performTextExtraction(int $fileId, array $ncFile): ?string\n{\n    $mimeType = $ncFile['mimetype'] ?? '';\n    \n    // Get file from Nextcloud\n    $nodes = $this->rootFolder->getById($fileId);\n    if (empty($nodes)) {\n        throw new Exception(\"File not found\");\n    }\n    \n    $file = $nodes[0];\n    if (!$file instanceof \\OCP\\Files\\File) {\n        throw new Exception(\"Node is not a file\");\n    }\n    \n    // Images need Dolphin AI (OCR)\n    if (strpos($mimeType, 'image/') === 0) {\n        $this->logger->info('[TextExtractionService] Image files require Dolphin AI for OCR');\n        return null;\n    }\n    \n    try {\n        // Use LLPhant FileDataReader\n        // Note: FileDataReader expects a file path, so create temp file\n        $tempFile = tmpfile();\n        $tempPath = stream_get_meta_data($tempFile)['uri'];\n        fwrite($tempFile, $file->getContent());\n        \n        $reader = new FileDataReader($tempPath);\n        $documents = $reader->getDocuments();\n        \n        fclose($tempFile);\n        \n        if (empty($documents)) {\n            return null;\n        }\n        \n        // Combine all documents into single text\n        $fullText = '';\n        foreach ($documents as $doc) {\n            $fullText .= $doc->content . \"\\n\\n\";\n        }\n        \n        return trim($fullText);\n    } catch (\\Exception $e) {\n        $this->logger->error('[TextExtractionService] LLPhant extraction failed: ' . $e->getMessage());\n        return null;\n    }\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"3-add-chunking-during-extraction",children:"3. Add Chunking During Extraction"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsxs)(n.strong,{children:["Update ",(0,i.jsx)(n.code,{children:"extractTextFromFile()"}),":"]})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",children:"public function extractTextFromFile(int $fileId, array $ncFile): array\n{\n    // Extract text using LLPhant\n    $fullText = $this->performTextExtraction($fileId, $ncFile);\n    \n    if (empty($fullText)) {\n        return ['text' => null, 'chunks' => []];\n    }\n    \n    // Get chunk settings from config\n    $chunkSize = $this->settingsService->getChunkSize(); // e.g., 1000\n    $chunkOverlap = $this->settingsService->getChunkOverlap(); // e.g., 200\n    \n    // Use LLPhant DocumentSplitter\n    $documents = [new Document($fullText)];\n    $chunks = DocumentSplitter::splitDocuments(\n        $documents,\n        $chunkSize,\n        \"\\n\",  // separator\n        $chunkOverlap\n    );\n    \n    // Convert LLPhant chunks to our format\n    $chunkArray = [];\n    foreach ($chunks as $chunk) {\n        $chunkArray[] = [\n            'text' => $chunk->content,\n            'start_offset' => 0, // LLPhant doesn't provide this\n            'end_offset' => strlen($chunk->content)\n        ];\n    }\n    \n    return [\n        'text' => $fullText,\n        'chunks' => $chunkArray\n    ];\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"benefits",children:"Benefits"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Simplified Code"}),": One library instead of multiple"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Better Chunking"}),": Overlap support built-in"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"More Formats"}),": LLPhant supports more file types"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Consistent"}),": Same chunking logic for all services"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Maintained"}),": LLPhant is actively maintained"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"migration-steps",children:"Migration Steps"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"\u2705 Install LLPhant (already in composer.json)"}),"\n",(0,i.jsx)(n.li,{children:"\u23f3 Update TextExtractionService to use FileDataReader"}),"\n",(0,i.jsx)(n.li,{children:"\u23f3 Update chunking to use DocumentSplitter"}),"\n",(0,i.jsx)(n.li,{children:"\u23f3 Remove manual extraction libraries"}),"\n",(0,i.jsx)(n.li,{children:"\u23f3 Test with various file formats"}),"\n",(0,i.jsx)(n.li,{children:"\u23f3 Update SOLR service to use pre-chunked data"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"related-documentation",children:"Related Documentation"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"/docs/development/llphant-setup",children:"LLPhant Setup"})," - LLPhant installation guide"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"/docs/technical/text-extraction-implementation",children:"Text Extraction Implementation"})," - Current text extraction implementation"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},28453:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>s});var r=t(96540);const i={},l=r.createContext(i);function a(e){const n=r.useContext(l);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),r.createElement(l.Provider,{value:n},e.children)}}}]);