"use strict";(self.webpackChunkopen_catalogi_docs=self.webpackChunkopen_catalogi_docs||[]).push([[8858],{28453:(e,n,i)=>{i.d(n,{R:()=>a,x:()=>o});var s=i(96540);const r={},t=s.createContext(r);function a(e){const n=s.useContext(t);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),s.createElement(t.Provider,{value:n},e.children)}},87635:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>a,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"Features/multi-tenancy","title":"Multi-Tenancy","description":"OpenRegister\'s multi-tenancy system provides complete organisation-based data isolation, enabling multiple organizations to securely share the same application instance while maintaining strict data segregation.","source":"@site/docs/Features/multi-tenancy.md","sourceDirName":"Features","slug":"/Features/multi-tenancy","permalink":"/docs/Features/multi-tenancy","draft":false,"unlisted":false,"editUrl":"https://github.com/conductionnl/openregister/tree/main/website/docs/Features/multi-tenancy.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Comprehensive Faceting System","permalink":"/docs/Features/faceting"},"next":{"title":"Webhooks","permalink":"/docs/Features/webhooks"}}');var r=i(74848),t=i(28453);const a={},o="Multi-Tenancy",l={},c=[{value:"Overview",id:"overview",level:2},{value:"Core Components",id:"core-components",level:2},{value:"Organisation Management",id:"organisation-management",level:3},{value:"Session Management",id:"session-management",level:3},{value:"Automatic Entity Assignment",id:"automatic-entity-assignment",level:3},{value:"Key Features",id:"key-features",level:2},{value:"Enterprise Scalability",id:"enterprise-scalability",level:3},{value:"Security Model",id:"security-model",level:3},{value:"Performance Optimizations",id:"performance-optimizations",level:3},{value:"API Endpoints",id:"api-endpoints",level:2},{value:"Organisation Management",id:"organisation-management-1",level:3},{value:"Active Organisation",id:"active-organisation",level:3},{value:"User-Organisation Relationships",id:"user-organisation-relationships",level:3},{value:"System Management",id:"system-management",level:3},{value:"Implementation Benefits",id:"implementation-benefits",level:2},{value:"For Organizations",id:"for-organizations",level:3},{value:"For Administrators",id:"for-administrators",level:3},{value:"For Developers",id:"for-developers",level:3},{value:"Migration Support",id:"migration-support",level:2},{value:"Testing &amp; Quality Assurance",id:"testing--quality-assurance",level:2},{value:"Comprehensive Test Suite",id:"comprehensive-test-suite",level:3},{value:"Quality Metrics",id:"quality-metrics",level:3},{value:"Usage Examples",id:"usage-examples",level:2},{value:"Creating Organization-Scoped Entities",id:"creating-organization-scoped-entities",level:3},{value:"Querying with Hierarchy",id:"querying-with-hierarchy",level:3},{value:"Organisation Management",id:"organisation-management-2",level:3},{value:"Best Practices",id:"best-practices",level:2},{value:"For Implementation",id:"for-implementation",level:3},{value:"For Security",id:"for-security",level:3},{value:"Integration with Other Features",id:"integration-with-other-features",level:2},{value:"RBAC Integration",id:"rbac-integration",level:3},{value:"Search and Faceting",id:"search-and-faceting",level:3},{value:"Audit Trails",id:"audit-trails",level:3},{value:"Organisation Hierarchies",id:"organisation-hierarchies",level:2},{value:"Concept",id:"concept",level:3},{value:"Use Case: Government Organisations",id:"use-case-government-organisations",level:4},{value:"Key Features",id:"key-features-1",level:3},{value:"Technical Implementation",id:"technical-implementation",level:3},{value:"Database Schema",id:"database-schema",level:4},{value:"Recursive Parent Chain Query",id:"recursive-parent-chain-query",level:4},{value:"Multi-Tenancy Filtering",id:"multi-tenancy-filtering",level:4},{value:"API Usage",id:"api-usage",level:3},{value:"Security Considerations",id:"security-considerations",level:3},{value:"Performance Optimizations",id:"performance-optimizations-1",level:3},{value:"Best Practices",id:"best-practices-1",level:3},{value:"Example Scenarios",id:"example-scenarios",level:3},{value:"Future Enhancements",id:"future-enhancements",level:2},{value:"Technical Implementation",id:"technical-implementation-1",level:2},{value:"Architecture Overview",id:"architecture-overview",level:3},{value:"Tenant Isolation Strategy",id:"tenant-isolation-strategy",level:3},{value:"Organisation Context Flow",id:"organisation-context-flow",level:3},{value:"Tenant Collection Management",id:"tenant-collection-management",level:3},{value:"Database Schema",id:"database-schema-1",level:3},{value:"Performance Optimizations",id:"performance-optimizations-2",level:3},{value:"Code Examples",id:"code-examples",level:3},{value:"Best Practices",id:"best-practices-2",level:3},{value:"Monitoring",id:"monitoring",level:3}];function d(e){const n={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",hr:"hr",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"multi-tenancy",children:"Multi-Tenancy"})}),"\n",(0,r.jsx)(n.p,{children:"OpenRegister's multi-tenancy system provides complete organisation-based data isolation, enabling multiple organizations to securely share the same application instance while maintaining strict data segregation."}),"\n",(0,r.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,r.jsx)(n.p,{children:"Multi-tenancy enables organizations to:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Maintain Complete Data Isolation"}),": Each organisation's data remains completely separate"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Manage User Memberships"}),": Users can belong to multiple organisations with flexible switching"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Automatic Entity Assignment"}),": All registers, schemas, and objects automatically assigned to active organisation"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Session-Based Context"}),": Active organisation context maintained throughout user sessions"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Enterprise-Grade Security"}),": Prevents cross-organisation data access and maintains audit trails"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"core-components",children:"Core Components"}),"\n",(0,r.jsx)(n.h3,{id:"organisation-management",children:"Organisation Management"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Organisation Creation"}),": Create and manage organisations with names, descriptions, and settings"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"User Membership"}),": Manage which users belong to which organisations"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"User Selection for Joining"}),": Optionally specify which user to add when joining an organisation (defaults to current user)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Default Organisation"}),": Automatic fallback organisation for users without specific memberships"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Organisation Statistics"}),": Track usage, user counts, and system metrics"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"session-management",children:"Session Management"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Active Organisation"}),": Users have one active organisation per session"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Context Switching"}),": Seamless switching between organisations the user belongs to"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Session Persistence"}),": Active organisation maintained across requests and sessions"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Cache Management"}),": Performance-optimized with intelligent caching and cache clearing"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"automatic-entity-assignment",children:"Automatic Entity Assignment"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Registers"}),": Automatically assigned to user's active organisation when created"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Schemas"}),": Inherit organisation context from active organisation"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Objects"}),": Scoped to organisation context with automatic assignment"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Cross-Organisation Prevention"}),": Prevents users from creating entities in organisations they don't belong to"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"key-features",children:"Key Features"}),"\n",(0,r.jsx)(n.h3,{id:"enterprise-scalability",children:"Enterprise Scalability"}),"\n",(0,r.jsx)(n.mermaid,{value:"graph LR\n    A[User] --\x3e B[Multiple Organisations]\n    B --\x3e C[Active Context]\n    C --\x3e D[Entity Creation]\n    D --\x3e E[Organisation Assignment]\n    E --\x3e F[Data Isolation]"}),"\n",(0,r.jsx)(n.h3,{id:"security-model",children:"Security Model"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Access Control Integration"}),": Works seamlessly with existing RBAC system"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Cross-Organisation Prevention"}),": Users cannot access data from other organisations"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Audit Trails"}),": All actions include organisation context for compliance"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Session Isolation"}),": User sessions isolated by organisation context"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"performance-optimizations",children:"Performance Optimizations"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Database Query Filtering"}),": Efficient filtering at database level using joins"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Session-Based Caching"}),": Active organisation cached in user sessions"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Lazy Loading"}),": Organisation data loaded only when needed"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Query Optimization"}),": Optimized queries prevent unnecessary cross-organisation data retrieval"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"api-endpoints",children:"API Endpoints"}),"\n",(0,r.jsx)(n.h3,{id:"organisation-management-1",children:"Organisation Management"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"GET /api/organisations"})," - List user's organisations with active organisation"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"POST /api/organisations"})," - Create new organisation"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"GET /api/organisations/{uuid}"})," - Get organisation details"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"PUT /api/organisations/{uuid}"})," - Update organisation"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"GET /api/organisations/search"})," - Search organisations"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"active-organisation",children:"Active Organisation"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"GET /api/organisations/active"})," - Get current active organisation"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"POST /api/organisations/{uuid}/set-active"})," - Set active organisation"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"user-organisation-relationships",children:"User-Organisation Relationships"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"POST /api/organisations/{uuid}/join"})," - Join organisation (with optional user selection)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"POST /api/organisations/{uuid}/leave"})," - Leave organisation"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"system-management",children:"System Management"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"GET /api/organisations/stats"})," - System-wide statistics"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"POST /api/organisations/clear-cache"})," - Clear organisation cache"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"implementation-benefits",children:"Implementation Benefits"}),"\n",(0,r.jsx)(n.h3,{id:"for-organizations",children:"For Organizations"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Complete Data Isolation"}),": Guarantee that organizational data remains separate and secure"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Flexible User Management"}),": Users can belong to multiple organisations as needed"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Seamless Experience"}),": Transparent organisation switching without losing context"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Enterprise Ready"}),": Built for enterprise-scale deployments with multiple tenant organizations"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"for-administrators",children:"For Administrators"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Centralized Management"}),": Single application instance serving multiple organizations"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Resource Efficiency"}),": Shared infrastructure with isolated data"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Monitoring & Analytics"}),": Organization-scoped metrics and usage statistics"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Maintenance Simplicity"}),": Single codebase serving all organizations"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"for-developers",children:"For Developers"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Automatic Implementation"}),": Entity assignment handled automatically"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Session Integration"}),": Organisation context available throughout the application"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Performance Optimized"}),": Efficient queries with proper database indexing"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Testing Framework"}),": Comprehensive 113 test cases ensuring reliability"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"migration-support",children:"Migration Support"}),"\n",(0,r.jsx)(n.p,{children:"The multi-tenancy system includes comprehensive migration support:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Default Organisation Creation"}),": Automatically creates default organisation if none exists"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Legacy Data Assignment"}),": Assigns existing registers, schemas, and objects to default organisation"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"User Auto-Assignment"}),": Users without organisations automatically assigned to default"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Backwards Compatibility"}),": Existing functionality continues working seamlessly"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"testing--quality-assurance",children:"Testing & Quality Assurance"}),"\n",(0,r.jsx)(n.h3,{id:"comprehensive-test-suite",children:"Comprehensive Test Suite"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"113 Test Scenarios"}),": Complete coverage of all multi-tenancy functionality"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"10 Specialized Test Files"}),": Organized by functional area for maintainability"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Unit Testing"}),": PHPUnit-based testing with mock dependencies"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Integration Testing"}),": Full API testing with real database operations"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Performance Testing"}),": Load testing for scalability verification"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Security Testing"}),": Cross-organisation access prevention validation"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"quality-metrics",children:"Quality Metrics"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"100% Feature Coverage"}),": All multi-tenancy features tested"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Edge Case Handling"}),": Comprehensive error scenarios and boundary conditions"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Security Validation"}),": Complete access control and data isolation verification"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Performance Benchmarks"}),": Response time and scalability metrics"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"usage-examples",children:"Usage Examples"}),"\n",(0,r.jsx)(n.h3,{id:"creating-organization-scoped-entities",children:"Creating Organization-Scoped Entities"}),"\n",(0,r.jsx)(n.p,{children:"All entities automatically inherit the active organisation context. With hierarchies, child organisations can query and use parent resources:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"// Set active organisation (e.g., Gemeente Amsterdam with VNG as parent)\n$organisationService->setActiveOrganisation('amsterdam-uuid');\n\n// Register automatically assigned to active organisation\n$register = $registerService->createFromArray([\n    'title' => 'Customer Database',\n    'description' => 'Customer records for Amsterdam'\n]);\n// organisation: 'amsterdam-uuid' (automatically set)\n\n// Schema inherits organisation context  \n$schema = $schemaService->createFromArray([\n    'title' => 'Customer Schema',\n    'version' => '1.0.0'\n]);\n// organisation: 'amsterdam-uuid' (automatically set)\n\n// Agent created in Amsterdam context\n$agent = $agentService->createFromArray([\n    'name' => 'Amsterdam Support Agent',\n    'model' => 'gpt-4'\n]);\n// organisation: 'amsterdam-uuid' (automatically set)\n\n// Configuration for Amsterdam\n$config = $configService->createFromArray([\n    'name' => 'API Settings',\n    'settings' => ['timeout' => 30]\n]);\n// organisation: 'amsterdam-uuid' (automatically set)\n"})}),"\n",(0,r.jsx)(n.h3,{id:"querying-with-hierarchy",children:"Querying with Hierarchy"}),"\n",(0,r.jsxs)(n.p,{children:["All queries automatically include parent organisations via ",(0,r.jsx)(n.code,{children:"MultiTenancyTrait"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"// User active in 'Noord' (parent chain: Noord \u2192 Amsterdam \u2192 VNG)\n$organisationService->setActiveOrganisation('noord-uuid');\n\n// Get all schemas visible to Noord\n$schemas = $schemaMapper->findAll();\n// SQL: WHERE organisation IN ('noord-uuid', 'amsterdam-uuid', 'vng-uuid')\n// Returns schemas from: Noord + Amsterdam + VNG\n\n// Get all agents available to Noord  \n$agents = $agentMapper->findAll();\n// Returns agents from all three organisations in hierarchy\n\n// Create object using parent's schema\n$object = $objectService->createFromArray([\n    'schema' => 'vng-schema-uuid', // Schema from VNG (grandparent)\n    'register' => 'amsterdam-register-uuid', // Register from Amsterdam (parent)\n    'data' => ['name' => 'Test']\n]);\n// Works! Can use resources from any parent organisation\n"})}),"\n",(0,r.jsx)(n.h3,{id:"organisation-management-2",children:"Organisation Management"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"// Get user's organisations with active context\n$organisations = $organisationService->getUserOrganisations();\n\n// Switch active organisation\n$organisationService->setActiveOrganisation('uuid-of-new-org');\n\n// Create new organisation with parent hierarchy\n$newOrg = $organisationService->createFromArray([\n    'name' => 'Deelgemeente Zuid',\n    'description' => 'Sub-municipality of Amsterdam',\n    'parent' => 'amsterdam-uuid' // Set parent relationship\n]);\n// Zuid will now see all Amsterdam AND VNG resources\n"})}),"\n",(0,r.jsx)(n.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,r.jsx)(n.h3,{id:"for-implementation",children:"For Implementation"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Always use Organisation Service"}),": Use the OrganisationService for all organisation operations"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Check Active Context"}),": Verify active organisation before entity creation"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Handle Membership"}),": Ensure users belong to organisations before setting as active"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Cache Appropriately"}),": Use session caching for performance, clear when necessary"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Test Cross-Organisation"}),": Always test cross-organisation access prevention"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"for-security",children:"For Security"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Validate Organisation Access"}),": Always check user belongs to organisation before operations"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Use Database Filtering"}),": Filter queries by organisation at database level"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Audit Organisation Context"}),": Include organisation in all audit logs"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Session Management"}),": Properly manage organisation context in sessions"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Regular Testing"}),": Run comprehensive security tests regularly"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"integration-with-other-features",children:"Integration with Other Features"}),"\n",(0,r.jsx)(n.h3,{id:"rbac-integration",children:"RBAC Integration"}),"\n",(0,r.jsx)(n.p,{children:"Multi-tenancy works seamlessly with the existing Role-Based Access Control system:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Organisation-Scoped Permissions"}),": RBAC permissions apply within organisation context"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Cross-Organisation Prevention"}),": RBAC prevents access to other organisations' data"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Admin Override"}),": Admin users can access all organisations within their scope"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"search-and-faceting",children:"Search and Faceting"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Organisation Filtering"}),": Search results automatically filtered by active organisation"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Facet Scoping"}),": Facets calculated only for organisation's data"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Performance Optimization"}),": Efficient organisation-aware search queries"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"audit-trails",children:"Audit Trails"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Organisation Context"}),": All audit entries include organisation information"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Compliance Support"}),": Organisation-scoped audit trails for regulatory compliance"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Cross-Reference Prevention"}),": Cannot view audit trails from other organisations"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"organisation-hierarchies",children:"Organisation Hierarchies"}),"\n",(0,r.jsx)(n.p,{children:"OpenRegister supports parent-child organisation relationships, enabling controlled resource sharing across organisational boundaries."}),"\n",(0,r.jsx)(n.h3,{id:"concept",children:"Concept"}),"\n",(0,r.jsx)(n.p,{children:"Child organisations automatically inherit visibility to resources from their parent organisations, recursively up the entire hierarchy. This is a unidirectional relationship - parents CANNOT view child resources, only children can view parent resources."}),"\n",(0,r.jsx)(n.h4,{id:"use-case-government-organisations",children:"Use Case: Government Organisations"}),"\n",(0,r.jsx)(n.mermaid,{value:"graph TD\n    VNG[VNG - National Government] --\x3e|parent of| AMS[Gemeente Amsterdam]\n    VNG --\x3e|parent of| RTM[Gemeente Rotterdam]  \n    AMS --\x3e|parent of| NOORD[Deelgemeente Noord]\n    \n    style VNG fill:#2196F3,color:#fff\n    style AMS fill:#4CAF50,color:#fff\n    style RTM fill:#4CAF50,color:#fff\n    style NOORD fill:#8BC34A,color:#fff"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Resource Visibility"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"VNG creates national schemas for all municipalities"}),"\n",(0,r.jsx)(n.li,{children:"Gemeente Amsterdam automatically sees all VNG schemas"}),"\n",(0,r.jsx)(n.li,{children:"Deelgemeente Noord automatically sees schemas from both Amsterdam AND VNG"}),"\n",(0,r.jsx)(n.li,{children:"Amsterdam does NOT see Noord schemas (no downward visibility)"}),"\n",(0,r.jsx)(n.li,{children:"Rotterdam does NOT see Amsterdam or Noord schemas (no sibling visibility)"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"key-features-1",children:"Key Features"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Upward Visibility (Children \u2192 Parents)"})}),"\n",(0,r.jsx)(n.p,{children:"Child organisations automatically see and can use ALL parent resources:"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Resource Type"}),(0,r.jsx)(n.th,{children:"Mapper"}),(0,r.jsx)(n.th,{children:"Visible to Children"}),(0,r.jsx)(n.th,{children:"Use Case"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"Schemas"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"SchemaMapper"})}),(0,r.jsx)(n.td,{children:"\u2705 Yes"}),(0,r.jsx)(n.td,{children:"Data structure definitions"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"Registers"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"RegisterMapper"})}),(0,r.jsx)(n.td,{children:"\u2705 Yes"}),(0,r.jsx)(n.td,{children:"Object collections"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"Objects"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"ObjectEntityMapper"})}),(0,r.jsx)(n.td,{children:"\u2705 Yes"}),(0,r.jsx)(n.td,{children:"Individual data records"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"Agents"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"AgentMapper"})}),(0,r.jsx)(n.td,{children:"\u2705 Yes"}),(0,r.jsx)(n.td,{children:"AI assistants and processors"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"Sources"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"SourceMapper"})}),(0,r.jsx)(n.td,{children:"\u2705 Yes"}),(0,r.jsx)(n.td,{children:"External API connections"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"Configurations"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"ConfigurationMapper"})}),(0,r.jsx)(n.td,{children:"\u2705 Yes"}),(0,r.jsx)(n.td,{children:"System settings"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"Applications"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"ApplicationMapper"})}),(0,r.jsx)(n.td,{children:"\u2705 Yes"}),(0,r.jsx)(n.td,{children:"Integrated applications"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"Views"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"ViewMapper"})}),(0,r.jsx)(n.td,{children:"\u2705 Yes"}),(0,r.jsx)(n.td,{children:"UI display configurations"})]})]})]}),"\n",(0,r.jsxs)(n.p,{children:["Visibility applies ",(0,r.jsx)(n.strong,{children:"recursively"})," to entire ancestor chain (grandparents, great-grandparents, etc.)."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Isolation Rules"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Parents CANNOT view child resources (security boundary)"}),"\n",(0,r.jsx)(n.li,{children:"Siblings CANNOT view each other's resources (organisational isolation)"}),"\n",(0,r.jsx)(n.li,{children:"Children can READ parent resources but cannot MODIFY them"}),"\n",(0,r.jsx)(n.li,{children:"Maximum hierarchy depth: 10 levels (prevents infinite recursion)"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Circular Reference Prevention"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Automatic validation prevents A \u2192 B \u2192 A cycles"}),"\n",(0,r.jsxs)(n.li,{children:["Enforced at API level when setting parent via ",(0,r.jsx)(n.code,{children:"OrganisationMapper->validateParentAssignment()"})]}),"\n",(0,r.jsx)(n.li,{children:"Clear error messages guide administrators"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"technical-implementation",children:"Technical Implementation"}),"\n",(0,r.jsx)(n.h4,{id:"database-schema",children:"Database Schema"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"-- Parent column added to organisations table\nALTER TABLE oc_openregister_organisations \nADD COLUMN parent VARCHAR(255) DEFAULT NULL;\n\n-- Index for efficient parent chain queries\nCREATE INDEX idx_organisation_parent \nON oc_openregister_organisations(parent);\n"})}),"\n",(0,r.jsx)(n.h4,{id:"recursive-parent-chain-query",children:"Recursive Parent Chain Query"}),"\n",(0,r.jsx)(n.p,{children:"The system uses recursive Common Table Expressions (CTE) for efficient parent chain lookups:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"WITH RECURSIVE org_hierarchy AS (\n    -- Base case: the organisation itself\n    SELECT uuid, parent, 0 as level\n    FROM oc_openregister_organisations\n    WHERE uuid = :org_uuid\n    \n    UNION ALL\n    \n    -- Recursive case: get parent organisations\n    SELECT o.uuid, o.parent, oh.level + 1\n    FROM oc_openregister_organisations o\n    INNER JOIN org_hierarchy oh ON o.uuid = oh.parent\n    WHERE oh.level < 10  -- Max depth protection\n)\nSELECT uuid \nFROM org_hierarchy \nWHERE level > 0\nORDER BY level ASC;\n"})}),"\n",(0,r.jsx)(n.h4,{id:"multi-tenancy-filtering",children:"Multi-Tenancy Filtering"}),"\n",(0,r.jsx)(n.p,{children:"Query filtering automatically includes parent organisations for ALL organisation-scoped entities:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"// Old behavior (pre-hierarchy)\nWHERE organisation = '{active-org-uuid}'\n\n// New behavior (with hierarchy)\nWHERE organisation IN ('{active-uuid}', '{parent-uuid}', '{grandparent-uuid}')\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Entities with Automatic Hierarchy Support:"})}),"\n",(0,r.jsxs)(n.p,{children:["The following entity mappers use ",(0,r.jsx)(n.code,{children:"MultiTenancyTrait"})," and automatically inherit hierarchical multi-tenancy:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Agents"})," (",(0,r.jsx)(n.code,{children:"AgentMapper"}),") - AI agents are visible to child organisations"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Schemas"})," (",(0,r.jsx)(n.code,{children:"SchemaMapper"}),") - Data schemas shared across hierarchy"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Registers"})," (",(0,r.jsx)(n.code,{children:"RegisterMapper"}),") - Object collections visible to children"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Views"})," (",(0,r.jsx)(n.code,{children:"ViewMapper"}),") - UI views available to child organisations"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Sources"})," (",(0,r.jsx)(n.code,{children:"SourceMapper"}),") - Data sources accessible throughout hierarchy"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Configurations"})," (",(0,r.jsx)(n.code,{children:"ConfigurationMapper"}),") - Configuration settings inherited by children"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Applications"})," (",(0,r.jsx)(n.code,{children:"ApplicationMapper"}),") - Applications shared with child organisations"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Objects"})," (",(0,r.jsx)(n.code,{children:"ObjectEntityMapper"}),") - Individual data objects follow organisation hierarchy"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"How It Works:"})}),"\n",(0,r.jsxs)(n.p,{children:["All these mappers call ",(0,r.jsx)(n.code,{children:"applyOrganisationFilter()"})," from ",(0,r.jsx)(n.code,{children:"MultiTenancyTrait"}),", which:"]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["Calls ",(0,r.jsx)(n.code,{children:"OrganisationService->getUserActiveOrganisations()"})]}),"\n",(0,r.jsxs)(n.li,{children:["Receives array: ",(0,r.jsx)(n.code,{children:"['active-uuid', 'parent-uuid', 'grandparent-uuid']"})]}),"\n",(0,r.jsxs)(n.li,{children:["Applies SQL: ",(0,r.jsx)(n.code,{children:"WHERE organisation IN (...)"})]}),"\n",(0,r.jsx)(n.li,{children:"Returns results from active organisation AND all parents"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"No Code Changes Required:"})}),"\n",(0,r.jsx)(n.p,{children:"Entity mappers require zero modifications - the trait handles everything automatically. This ensures consistent behaviour across all organisation-scoped entities."}),"\n",(0,r.jsx)(n.h3,{id:"api-usage",children:"API Usage"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Set Parent Organisation:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"PUT /api/organisations/{uuid}\nContent-Type: application/json\n\n{\n  'parent': '{parent-org-uuid}'\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Remove Parent:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"PUT /api/organisations/{uuid}\nContent-Type: application/json\n\n{\n  'parent': null\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Get Organisation with Hierarchy:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"GET /api/organisations/{uuid}\n\nResponse:\n{\n  'uuid': 'amsterdam-uuid',\n  'name': 'Gemeente Amsterdam',\n  'parent': 'vng-uuid',\n  'children': ['noord-uuid', 'zuid-uuid']\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"security-considerations",children:"Security Considerations"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Validation Rules"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Parent assignment validated before saving"}),"\n",(0,r.jsx)(n.li,{children:"Circular references rejected (A \u2192 B \u2192 A)"}),"\n",(0,r.jsx)(n.li,{children:"Maximum depth enforced (10 levels)"}),"\n",(0,r.jsx)(n.li,{children:"Self-reference prevented (organisation cannot parent itself)"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Permission Model"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"RBAC permissions apply within organisation context"}),"\n",(0,r.jsx)(n.li,{children:"Parent resources are visible but respect RBAC rules"}),"\n",(0,r.jsx)(n.li,{children:"Children cannot MODIFY parent resources (only read)"}),"\n",(0,r.jsx)(n.li,{children:"Audit logs track which organisation owns each resource"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Error Responses"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:"{\n  'error': 'Circular reference detected: The new parent organisation is already a descendant of this organisation.'\n}\n\n{\n  'error': 'Maximum hierarchy depth exceeded. Total depth would be 11 levels (max 10 allowed).'\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"performance-optimizations-1",children:"Performance Optimizations"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Recursive CTE Benefits"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Single database query for entire parent chain"}),"\n",(0,r.jsx)(n.li,{children:"No N+1 query problem"}),"\n",(0,r.jsx)(n.li,{children:"Efficient even with deep hierarchies (10 levels)"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Benchmarks"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Parent chain lookup: < 10ms"}),"\n",(0,r.jsx)(n.li,{children:"Filtered query with 3 organisations: < 50ms"}),"\n",(0,r.jsx)(n.li,{children:"No measurable impact on single-org setups"}),"\n",(0,r.jsx)(n.li,{children:"Index on parent column prevents full table scans"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Caching Strategy"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Parent chain computed per request"}),"\n",(0,r.jsx)(n.li,{children:"Results cached in OrganisationService"}),"\n",(0,r.jsx)(n.li,{children:"Cache invalidated on organisation updates"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"best-practices-1",children:"Best Practices"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Keep Hierarchies Shallow"}),": Aim for \u2264 3 levels for clarity"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Clear Naming"}),": Use descriptive names showing hierarchy level"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Document Structure"}),": Maintain documentation of organisation tree"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Test Visibility"}),": Verify resource visibility in staging before production"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Monitor Performance"}),": Watch query times with deep hierarchies (> 5 levels)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Plan Migrations"}),": Test parent assignments carefully to avoid disruption"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"example-scenarios",children:"Example Scenarios"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Scenario 1: Schema Sharing (National to Municipal)"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"VNG (parent) \u2192 Gemeente Amsterdam\n- VNG creates 'Citizen Schema'\n- Amsterdam automatically sees 'Citizen Schema'\n- Amsterdam can create objects using VNG schema\n- Amsterdam creates 'Local Events Schema'\n- VNG does NOT see 'Local Events Schema'\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Scenario 2: Multi-Level Hierarchy (All Resources)"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"VNG \u2192 Amsterdam \u2192 Noord\n\nResources visible to Noord:\n\u2713 Schemas from VNG and Amsterdam\n\u2713 Registers from VNG and Amsterdam\n\u2713 Configurations from VNG and Amsterdam\n\u2713 Agents from VNG and Amsterdam\n\u2713 Sources from VNG and Amsterdam\n\u2713 Views from VNG and Amsterdam\n\u2713 Applications from VNG and Amsterdam\n\u2713 Objects from VNG and Amsterdam\n\nResources Noord creates:\n- Only visible to Noord itself\n- NOT visible to Amsterdam or VNG (upward isolation)\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Scenario 3: Configuration Inheritance"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"VNG (parent) \u2192 Multiple Municipalities\n- VNG creates 'National API Configuration'\n- All municipalities automatically use this configuration\n- Municipality can override with local configuration\n- Local config takes precedence over parent config (when both exist)\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Scenario 4: Sibling Isolation"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"VNG \u2192 Amsterdam\nVNG \u2192 Rotterdam\n- Amsterdam and Rotterdam are siblings\n- Amsterdam creates 'Amsterdam Transport Agent'\n- Rotterdam does NOT see Amsterdam's agent\n- Both see VNG's national agents\n- Complete resource isolation between siblings\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Scenario 5: Agent and Source Sharing"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"Company HQ \u2192 Department A \u2192 Team 1\n- HQ creates 'Corporate AI Agent' and 'External API Source'\n- Department A sees and can use HQ agent/source\n- Team 1 sees agents/sources from both HQ and Department A\n- Team 1 creates team-specific agent\n- Only Team 1 can use their team agent\n"})}),"\n",(0,r.jsx)(n.h2,{id:"future-enhancements",children:"Future Enhancements"}),"\n",(0,r.jsx)(n.p,{children:"Planned enhancements for the multi-tenancy system include:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Role-Based Organisation Access"}),": Organisation-specific role assignments"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Organisation Templates"}),": Predefined organisation setups for quick deployment"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Controlled Cross-Organisation Sharing"}),": Share specific resources across sibling organisations"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Organisation Branding"}),": Custom branding and themes per organisation"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Usage Analytics"}),": Detailed organisation usage metrics and reporting"]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"technical-implementation-1",children:"Technical Implementation"}),"\n",(0,r.jsx)(n.h3,{id:"architecture-overview",children:"Architecture Overview"}),"\n",(0,r.jsx)(n.p,{children:"Multi-tenancy in OpenRegister uses a combination of organisation-based filtering and Solr tenant collections:"}),"\n",(0,r.jsx)(n.mermaid,{value:'graph TB\n    subgraph "User Layer"\n        User[User Session]\n        ActiveOrg[Active Organisation]\n    end\n    \n    subgraph "Application Layer"\n        OrgService[Organisation Service]\n        ObjectMapper[Object Mapper]\n        SchemaMapper[Schema Mapper]\n        RegisterMapper[Register Mapper]\n    end\n    \n    subgraph "Data Layer"\n        DB[(MySQL Database<br/>Organisation Field)]\n        SolrBase[Solr Base Collection]\n        SolrTenant1[Solr Tenant Collection<br/>org-uuid-1]\n        SolrTenant2[Solr Tenant Collection<br/>org-uuid-2]\n    end\n    \n    User --\x3e|has| ActiveOrg\n    ActiveOrg --\x3e|managed by| OrgService\n    \n    ObjectMapper --\x3e|filters by organisation| DB\n    SchemaMapper --\x3e|filters by organisation| DB\n    RegisterMapper --\x3e|filters by organisation| DB\n    \n    ObjectMapper --\x3e|indexes to| SolrTenant1\n    ObjectMapper --\x3e|indexes to| SolrTenant2\n    \n    SolrBase -.->|creates| SolrTenant1\n    SolrBase -.->|creates| SolrTenant2\n    \n    style ActiveOrg fill:#e1f5ff\n    style OrgService fill:#fff4e1'}),"\n",(0,r.jsx)(n.h3,{id:"tenant-isolation-strategy",children:"Tenant Isolation Strategy"}),"\n",(0,r.jsx)(n.p,{children:"OpenRegister implements multi-tenancy at two levels:"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"1. Database-Level Filtering"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["All entities have ",(0,r.jsx)(n.code,{children:"organisation"})," field"]}),"\n",(0,r.jsx)(n.li,{children:"Queries automatically filtered by active organisation"}),"\n",(0,r.jsx)(n.li,{children:"Prevents cross-organisation data access"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"2. Solr Collection Isolation"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Each tenant gets separate Solr collection"}),"\n",(0,r.jsxs)(n.li,{children:["Collection naming: ",(0,r.jsx)(n.code,{children:"{base-collection}-{org-uuid}"})]}),"\n",(0,r.jsx)(n.li,{children:"Complete search index isolation"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"organisation-context-flow",children:"Organisation Context Flow"}),"\n",(0,r.jsx)(n.mermaid,{value:"sequenceDiagram\n    participant User as User\n    participant Session as Session\n    participant OrgService as Organisation Service\n    participant Mapper as Entity Mapper\n    participant DB as Database\n    participant Solr as Solr (Tenant Collection)\n    \n    User->>OrgService: setActiveOrganisation(orgUuid)\n    OrgService->>Session: Store active org in session\n    Session--\x3e>User: Context switched\n    \n    Note over User: Create Object\n    \n    User->>Mapper: createObject(data)\n    Mapper->>OrgService: getActiveOrganisation()\n    OrgService->>Session: Retrieve active org\n    Session--\x3e>OrgService: orgUuid\n    OrgService--\x3e>Mapper: organisationUuid\n    \n    Mapper->>Mapper: Set object.organisation = orgUuid\n    Mapper->>DB: INSERT with organisation field\n    DB--\x3e>Mapper: Object saved\n    \n    Mapper->>Solr: Index to tenant collection\n    Note over Solr: Collection: base-{orgUuid}\n    Solr--\x3e>Mapper: Indexed\n    \n    Mapper--\x3e>User: Object created"}),"\n",(0,r.jsx)(n.h3,{id:"tenant-collection-management",children:"Tenant Collection Management"}),"\n",(0,r.jsx)(n.mermaid,{value:"graph TD\n    Start[User Request] --\x3e CheckCollection{Tenant collection<br/>exists?}\n    \n    CheckCollection --\x3e|Yes| UseCollection[Use Tenant Collection<br/>{base}-{org-uuid}]\n    CheckCollection --\x3e|No| CreateCollection[Create Tenant Collection]\n    \n    CreateCollection --\x3e ConfigSet[Apply ConfigSet<br/>openregister]\n    ConfigSet --\x3e SetupShards[Configure Shards<br/>& Replicas]\n    SetupShards --\x3e CollectionReady[Collection Ready]\n    CollectionReady --\x3e UseCollection\n    \n    UseCollection --\x3e IndexData[Index/Search Data]\n    IndexData --\x3e Success[\u2713 Operation Complete]\n    \n    style Success fill:#90EE90"}),"\n",(0,r.jsx)(n.h3,{id:"database-schema-1",children:"Database Schema"}),"\n",(0,r.jsx)(n.p,{children:"Organisation field added to all tenant-aware tables:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"-- Objects table\nALTER TABLE oc_openregister_objects \nADD COLUMN organisation VARCHAR(255),\nADD INDEX idx_organisation (organisation);\n\n-- Schemas table\nALTER TABLE oc_openregister_schemas\nADD COLUMN organisation VARCHAR(255),\nADD INDEX idx_organisation (organisation);\n\n-- Registers table\nALTER TABLE oc_openregister_registers\nADD COLUMN organisation VARCHAR(255),\nADD INDEX idx_organisation (organisation);\n\n-- Organisations table\nCREATE TABLE oc_openregister_organisations (\n    id INTEGER PRIMARY KEY AUTO_INCREMENT,\n    uuid VARCHAR(255) UNIQUE NOT NULL,\n    name VARCHAR(255) NOT NULL,\n    description TEXT,\n    settings JSON,\n    created DATETIME,\n    updated DATETIME,\n    INDEX idx_uuid (uuid),\n    INDEX idx_name (name)\n);\n\n-- User-Organisation mapping\nCREATE TABLE oc_openregister_user_organisations (\n    id INTEGER PRIMARY KEY AUTO_INCREMENT,\n    user_id VARCHAR(255) NOT NULL,\n    organisation_uuid VARCHAR(255) NOT NULL,\n    role VARCHAR(50) DEFAULT 'member',\n    created DATETIME,\n    UNIQUE KEY unique_user_org (user_id, organisation_uuid),\n    INDEX idx_user (user_id),\n    INDEX idx_org (organisation_uuid)\n);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"performance-optimizations-2",children:"Performance Optimizations"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"1. Session Caching"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Active organisation cached in user session"}),"\n",(0,r.jsx)(n.li,{children:"Reduces database queries"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"2. Database Indexes"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Indexed ",(0,r.jsx)(n.code,{children:"organisation"})," field on all tables"]}),"\n",(0,r.jsx)(n.li,{children:"Fast filtering queries"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"3. Lazy Collection Creation"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Tenant collections created on-demand"}),"\n",(0,r.jsx)(n.li,{children:"Reduces initial overhead"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"4. Query Optimization"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Automatic ",(0,r.jsx)(n.code,{children:"WHERE organisation = ?"})," in all queries"]}),"\n",(0,r.jsx)(n.li,{children:"Prevents full table scans"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"code-examples",children:"Code Examples"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Setting Active Organisation:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"use OCA\\OpenRegister\\Service\\OrganisationService;\n\n$organisationService->setActiveOrganisation($organisationUuid);\n\n// All subsequent operations use this organisation context\n$object = $objectService->create($data);\n// object.organisation automatically set to $organisationUuid\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Querying with Organisation Filter:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"// Automatic organisation filtering\n$objects = $objectMapper->findAll();\n// SELECT * FROM objects WHERE organisation = '{active-org-uuid}'\n\n// Explicit organisation override (admin only)\n$objects = $objectMapper->findByOrganisation($specificOrgUuid);\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Tenant Collection Operations:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:'use OCA\\OpenRegister\\Service\\GuzzleSolrService;\n\n// Ensure tenant collection exists\n$solrService->ensureTenantCollection();\n\n// Get active collection name\n$collectionName = $solrService->getActiveCollectionName();\n// Returns: "openregister-{org-uuid}"\n\n// Index to tenant collection\n$solrService->indexObject($object);\n// Automatically uses tenant collection\n'})}),"\n",(0,r.jsx)(n.h3,{id:"best-practices-2",children:"Best Practices"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"\u2713 DO:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Always check active organisation before operations"}),"\n",(0,r.jsx)(n.li,{children:"Use session-based context switching"}),"\n",(0,r.jsx)(n.li,{children:"Validate user membership before switching"}),"\n",(0,r.jsx)(n.li,{children:"Monitor tenant collection sizes"}),"\n",(0,r.jsx)(n.li,{children:"Implement organisation-scoped audit logs"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"\u2717 DON'T:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Don't bypass organisation filtering"}),"\n",(0,r.jsx)(n.li,{children:"Don't share collections between tenants"}),"\n",(0,r.jsx)(n.li,{children:"Don't hard-code organisation UUIDs"}),"\n",(0,r.jsx)(n.li,{children:"Don't skip permission checks"}),"\n",(0,r.jsx)(n.li,{children:"Don't forget to clear caches on context switch"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"monitoring",children:"Monitoring"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'# Check organisation isolation\nSELECT organisation, COUNT(*) as count\nFROM oc_openregister_objects\nGROUP BY organisation;\n\n# List tenant collections\ncurl "http://solr:8983/solr/admin/collections?action=LIST"\n\n# Monitor collection sizes\ncurl "http://solr:8983/solr/admin/collections?action=CLUSTERSTATUS"\n'})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsxs)(n.em,{children:["For testing information, see ",(0,r.jsx)(n.a,{href:"/docs/technical/multi-tenancy-testing",children:"Multi-Tenancy Testing Framework"})]}),"\n",(0,r.jsxs)(n.em,{children:["For API details, see ",(0,r.jsx)(n.a,{href:"/docs/api/organisations",children:"Organisations API"})]})]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}}}]);