"use strict";(self.webpackChunkopen_catalogi_docs=self.webpackChunkopen_catalogi_docs||[]).push([[1156],{16266:(n,e,i)=>{i.r(e),i.d(e,{assets:()=>o,contentTitle:()=>l,default:()=>u,frontMatter:()=>s,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"technical/organization-filter-consolidation","title":"Organization Filter Consolidation","description":"Overview","source":"@site/docs/technical/organization-filter-consolidation.md","sourceDirName":"technical","slug":"/technical/organization-filter-consolidation","permalink":"/docs/technical/organization-filter-consolidation","draft":false,"unlisted":false,"editUrl":"https://github.com/conductionnl/openregister/tree/main/website/docs/technical/organization-filter-consolidation.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Multi-Tenancy Testing Framework","permalink":"/docs/technical/multi-tenancy-testing"},"next":{"title":"php","permalink":"/docs/technical/php"}}');var a=i(74848),r=i(28453);const s={},l="Organization Filter Consolidation",o={},d=[{value:"Overview",id:"overview",level:2},{value:"Changes Made",id:"changes-made",level:2},{value:"1. Enhanced <code>applyOrganisationFilter()</code> in MultiTenancyTrait",id:"1-enhanced-applyorganisationfilter-in-multitenancytrait",level:3},{value:"2. Parameters Explanation",id:"2-parameters-explanation",level:3},{value:"3. ObjectEntityMapper Integration",id:"3-objectentitymapper-integration",level:3}];function c(n){const e={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...n.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(e.header,{children:(0,a.jsx)(e.h1,{id:"organization-filter-consolidation",children:"Organization Filter Consolidation"})}),"\n",(0,a.jsx)(e.h2,{id:"overview",children:"Overview"}),"\n",(0,a.jsxs)(e.p,{children:["The organization filtering functionality has been consolidated into a single, comprehensive method in the ",(0,a.jsx)(e.code,{children:"MultiTenancyTrait"})," to prevent code duplication and provide consistent multi-tenancy behavior across all entities."]}),"\n",(0,a.jsx)(e.h2,{id:"changes-made",children:"Changes Made"}),"\n",(0,a.jsxs)(e.h3,{id:"1-enhanced-applyorganisationfilter-in-multitenancytrait",children:["1. Enhanced ",(0,a.jsx)(e.code,{children:"applyOrganisationFilter()"})," in MultiTenancyTrait"]}),"\n",(0,a.jsxs)(e.p,{children:["The ",(0,a.jsx)(e.code,{children:"applyOrganisationFilter()"})," method in ",(0,a.jsx)(e.code,{children:"MultiTenancyTrait"})," has been enhanced with advanced features:"]}),"\n",(0,a.jsx)(e.p,{children:(0,a.jsx)(e.strong,{children:"Features:"})}),"\n",(0,a.jsxs)(e.ul,{children:["\n",(0,a.jsx)(e.li,{children:"\u2705 Hierarchical organisation support (active org + all parents)"}),"\n",(0,a.jsx)(e.li,{children:"\u2705 Published object bypass for multi-tenancy (objects table only)"}),"\n",(0,a.jsx)(e.li,{children:"\u2705 Admin override capabilities"}),"\n",(0,a.jsx)(e.li,{children:"\u2705 System default organisation special handling"}),"\n",(0,a.jsx)(e.li,{children:"\u2705 NULL organisation legacy data access for admins"}),"\n",(0,a.jsx)(e.li,{children:"\u2705 Unauthenticated request handling"}),"\n",(0,a.jsx)(e.li,{children:"\u2705 Multitenancy configuration checking"}),"\n"]}),"\n",(0,a.jsx)(e.p,{children:(0,a.jsx)(e.strong,{children:"Method Signature:"})}),"\n",(0,a.jsx)(e.p,{children:"'''php\nprotected function applyOrganisationFilter(\nIQueryBuilder $qb,\nstring $columnName = 'organisation',\nbool $allowNullOrg = false,\nstring $tableAlias = '',\nbool $enablePublished = false\n): void\n'''"}),"\n",(0,a.jsx)(e.h3,{id:"2-parameters-explanation",children:"2. Parameters Explanation"}),"\n",(0,a.jsxs)(e.table,{children:[(0,a.jsx)(e.thead,{children:(0,a.jsxs)(e.tr,{children:[(0,a.jsx)(e.th,{children:"Parameter"}),(0,a.jsx)(e.th,{children:"Type"}),(0,a.jsx)(e.th,{children:"Default"}),(0,a.jsx)(e.th,{children:"Description"})]})}),(0,a.jsxs)(e.tbody,{children:[(0,a.jsxs)(e.tr,{children:[(0,a.jsx)(e.td,{children:(0,a.jsx)(e.code,{children:"$qb"})}),(0,a.jsx)(e.td,{children:"IQueryBuilder"}),(0,a.jsx)(e.td,{children:"Required"}),(0,a.jsx)(e.td,{children:"The query builder instance"})]}),(0,a.jsxs)(e.tr,{children:[(0,a.jsx)(e.td,{children:(0,a.jsx)(e.code,{children:"$columnName"})}),(0,a.jsx)(e.td,{children:"string"}),(0,a.jsx)(e.td,{children:"'organisation'"}),(0,a.jsx)(e.td,{children:"Column name for organisation filtering"})]}),(0,a.jsxs)(e.tr,{children:[(0,a.jsx)(e.td,{children:(0,a.jsx)(e.code,{children:"$allowNullOrg"})}),(0,a.jsx)(e.td,{children:"bool"}),(0,a.jsx)(e.td,{children:"false"}),(0,a.jsx)(e.td,{children:"Allow admins to see NULL organisation entities (legacy data)"})]}),(0,a.jsxs)(e.tr,{children:[(0,a.jsx)(e.td,{children:(0,a.jsx)(e.code,{children:"$tableAlias"})}),(0,a.jsx)(e.td,{children:"string"}),(0,a.jsx)(e.td,{children:"''"}),(0,a.jsx)(e.td,{children:"Table alias for published/depublished columns"})]}),(0,a.jsxs)(e.tr,{children:[(0,a.jsx)(e.td,{children:(0,a.jsx)(e.code,{children:"$enablePublished"})}),(0,a.jsx)(e.td,{children:"bool"}),(0,a.jsx)(e.td,{children:"false"}),(0,a.jsx)(e.td,{children:"Enable published object bypass (objects table only)"})]})]})]}),"\n",(0,a.jsx)(e.h3,{id:"3-objectentitymapper-integration",children:"3. ObjectEntityMapper Integration"}),"\n",(0,a.jsxs)(e.p,{children:[(0,a.jsx)(e.code,{children:"ObjectEntityMapper"})," now uses the ",(0,a.jsx)(e.code,{children:"MultiTenancyTrait"})," and has access to the enhanced filtering method:"]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-php",children:"class ObjectEntityMapper extends QBMapper\n{\n    use MultiTenancyTrait;\n    \n    // OrganisationService injected in constructor\n    private OrganisationService $organisationService;\n    \n    // Call the enhanced filter method\n    $this->applyOrganisationFilter(\n        qb: $qb,\n        columnName: 'organisation',\n        allowNullOrg: true,        // Admins can see NULL org objects\n        tableAlias: 'o',             // Objects table alias\n        enablePublished: true        // Enable published bypass\n    );\n}\n'''\n\n### 4. Other Mappers Usage\n\nFor entities without published/depublished fields, simply use the method without those parameters:\n\n'''php\nclass SchemaMapper extends QBMapper\n{\n    use MultiTenancyTrait;\n    \n    // Simple organisation filtering\n    $this->applyOrganisationFilter(\n        qb: $qb,\n        columnName: 'organisation',\n        allowNullOrg: false  // Standard filtering\n    );\n}\n'''\n\n## Benefits\n\n### 1. Code Consolidation\n- **Before**: Duplicate filtering logic in `ObjectEntityMapper::applyOrganizationFilters()` and `MultiTenancyTrait::applyOrganisationFilter()`\n- **After**: Single source of truth in `MultiTenancyTrait::applyOrganisationFilter()`\n\n### 2. Consistent Behavior\n- All entities now use the same advanced filtering logic\n- Published object bypass can be enabled for any entity with published/depublished fields\n- Admin override and default organisation handling consistent across all mappers\n\n### 3. Flexibility\n- Conditional published/depublished logic based on `$enablePublished` parameter\n- Works for both simple and complex entity filtering\n- Easy to extend with additional features\n\n### 4. Maintainability\n- Single method to update for security fixes or feature enhancements\n- Clear documentation of all multitenancy behaviors\n- Consistent parameter naming and signatures\n\n## Technical Details\n\n### Published Object Bypass\n\nWhen `$enablePublished` is true, the filter adds logic to include published objects regardless of organisation:\n\n'''php\n// Published objects visible across organisations\nif ($publishedBypassEnabled && $enablePublished) {\n    $now = (new \\DateTime())->format('Y-m-d H:i:s');\n    $orgConditions->add(\n        $qb->expr()->andX(\n            $qb->expr()->isNotNull($publishedColumn),\n            $qb->expr()->lte($publishedColumn, $qb->createNamedParameter($now)),\n            $qb->expr()->orX(\n                $qb->expr()->isNull($depublishedColumn),\n                $qb->expr()->gt($depublishedColumn, $qb->createNamedParameter($now))\n            )\n        )\n    );\n}\n'''\n\n### Configuration Checking\n\nThe filter automatically checks multitenancy configuration:\n\n'''php\n// Check if multitenancy is enabled\nif (isset($this->appConfig)) {\n    $multitenancyConfig = $this->appConfig->getValueString('openregister', 'multitenancy', '');\n    if (!empty($multitenancyConfig)) {\n        $multitenancyData = json_decode($multitenancyConfig, true);\n        $multitenancyEnabled = $multitenancyData['enabled'] ?? true;\n        \n        if (!$multitenancyEnabled) {\n            // Multitenancy disabled, skip filtering\n            return;\n        }\n    }\n}\n'''\n\n### Admin Override\n\nAdmins with override enabled see all entities:\n\n'''php\n$adminOverrideEnabled = false;\nif ($isAdmin && isset($this->appConfig)) {\n    $multitenancyConfig = $this->appConfig->getValueString('openregister', 'multitenancy', '');\n    if (!empty($multitenancyConfig)) {\n        $multitenancyData = json_decode($multitenancyConfig, true);\n        $adminOverrideEnabled = $multitenancyData['adminOverride'] ?? false;\n    }\n}\n\nif ($isAdmin && $adminOverrideEnabled) {\n    // No filtering for admins\n    return;\n}\n'''\n\n## Migration Guide\n\n### For Developers\n\nIf you have custom mappers using organisation filtering:\n\n**Old Way:**\n'''php\n// Custom organisation filter in your mapper\nprivate function myCustomOrgFilter(IQueryBuilder $qb) {\n    // Complex filtering logic...\n}\n'''\n\n**New Way:**\n'''php\n// Use the trait\nclass MyCustomMapper extends QBMapper\n{\n    use MultiTenancyTrait;\n    \n    // Required dependencies\n    private OrganisationService $organisationService;\n    private IUserSession $userSession;\n    private IGroupManager $groupManager;\n    \n    // Optional for advanced features\n    private IAppConfig $appConfig;\n    private LoggerInterface $logger;\n    \n    public function findAll() {\n        $qb = $this->db->getQueryBuilder();\n        $qb->select('*')->from($this->tableName);\n        \n        // Apply standard organisation filtering\n        $this->applyOrganisationFilter($qb);\n        \n        return $this->findEntities($qb);\n    }\n}\n'''\n\n### For ObjectEntity Queries\n\nIf you were calling the old `applyOrganizationFilters()` method:\n\n**Old Way:**\n'''php\n$this->applyOrganizationFilters(\n    $qb, \n    'o',                      // table alias\n    $activeOrganisationUuids, // org UUIDs\n    $multi                    // multitenancy flag\n);\n'''\n\n**New Way:**\n'''php\n$this->applyOrganisationFilter(\n    qb: $qb,\n    columnName: 'organisation',\n    allowNullOrg: true,\n    tableAlias: 'o',\n    enablePublished: true\n);\n'''\n\n## Entity Properties\n\n### Required Properties\n\nFor proper organisation filtering, entities should have:\n\n| Property | Type | Purpose | Required |\n|----------|------|---------|----------|\n| `organisation` | string (UUID) | Organisation ownership | \u2705 Yes |\n| `owner` | string (userId) | Entity owner | \u2705 Recommended |\n| `created` | DateTime | Creation timestamp | \u2705 Recommended |\n\n### Optional Properties (for Advanced Features)\n\n| Property | Type | Purpose | Used By |\n|----------|------|---------|---------|\n| `published` | DateTime | Publication date | ObjectEntity |\n| `depublished` | DateTime | Depublication date | ObjectEntity |\n| `deleted` | DateTime/array | Soft delete timestamp | Schema, Register, ObjectEntity |\n\n### Current Entity Status\n\n| Entity | organisation | owner | created | deleted | published |\n|--------|-------------|-------|---------|---------|-----------|\n| ObjectEntity | \u2705 | \u2705 | \u2705 | \u2705 | \u2705 |\n| Schema | \u2705 | \u2705 | \u2705 | \u2705 | \u274c |\n| Register | \u2705 | \u2705 | \u2705 | \u2705 | \u274c |\n| Agent | \u2705 | \u2705 | \u2705 | \u274c | \u274c |\n| Application | \u2705 | \u2705 | \u2705 | \u274c | \u274c |\n| Source | \u2705 | \u274c | \u2705 | \u274c | \u274c |\n| View | \u2705 | \u2705 | \u2705 | \u274c | \u274c |\n| Configuration | \u2705 | \u2705 | \u2705 | \u274c | \u274c |\n\nNote: Only `ObjectEntity` has `published`/`depublished` fields, so only ObjectEntity queries should use `enablePublished: true`.\n\n## Testing\n\nTest your mapper's organisation filtering:\n\n'''php\npublic function testOrganisationFiltering() {\n    // Setup: Create test organisations and entities\n    $org1 = $this->createOrganisation('Org 1');\n    $org2 = $this->createOrganisation('Org 2');\n    \n    $entity1 = $this->createEntity(['organisation' => $org1->getUuid()]);\n    $entity2 = $this->createEntity(['organisation' => $org2->getUuid()]);\n    \n    // Set active organisation to org1\n    $this->organisationService->setActiveOrganisation($org1->getUuid());\n    \n    // Test: findAll should only return entity1\n    $results = $this->mapper->findAll();\n    \n    $this->assertCount(1, $results);\n    $this->assertEquals($entity1->getId(), $results[0]->getId());\n}\n'''\n\n## Security Considerations\n\n1. **Always Filter at Database Level**: Organisation filtering is applied at the query level for security\n2. **Never Trust Client Input**: Organisation is set from session, not from user input\n3. **Admin Privileges**: Carefully consider when to enable `allowNullOrg` or admin override\n4. **Published Bypass**: Only enable for public-facing content with proper publication workflow\n5. **Audit Logging**: All organisation context is logged for compliance\n\n## Future Enhancements\n\nPotential improvements to consider:\n\n1. **Caching**: Cache organisation hierarchy lookups\n2. **Performance**: Optimize recursive parent chain queries\n3. **Extended Entities**: Add published/depublished to more entities as needed\n4. **Granular Permissions**: Per-entity published bypass configuration\n5. **Cross-Organisation Sharing**: Explicit sharing mechanisms between organisations\n\n## References\n\n- [Multi-Tenancy Documentation](./multi-tenancy.md)\n- [Organisation Hierarchies](../Features/multi-tenancy.md#organisation-hierarchies)\n- [MultiTenancyTrait Source](../../lib/Db/MultiTenancyTrait.php)\n- [ObjectEntityMapper Source](../../lib/Db/ObjectEntityMapper.php)\n\n## Changelog\n\n### v0.2.7-beta.151 (Current)\n\n- \u2705 Consolidated organisation filtering into `MultiTenancyTrait`\n- \u2705 Added conditional published/depublished logic\n- \u2705 Enhanced `ObjectEntityMapper` to use trait\n- \u2705 Added comprehensive documentation\n- \u2705 No breaking changes (backward compatible)\n\n---\n\n**Last Updated**: November 11, 2025  \n**Author**: Conduction Development Team  \n**Status**: Complete \u2705\n\n\n\n\n"})})]})}function u(n={}){const{wrapper:e}={...(0,r.R)(),...n.components};return e?(0,a.jsx)(e,{...n,children:(0,a.jsx)(c,{...n})}):c(n)}},28453:(n,e,i)=>{i.d(e,{R:()=>s,x:()=>l});var t=i(96540);const a={},r=t.createContext(a);function s(n){const e=t.useContext(r);return t.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function l(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(a):n.components||a:s(n.components),t.createElement(r.Provider,{value:e},n.children)}}}]);