"use strict";(self.webpackChunkopen_catalogi_docs=self.webpackChunkopen_catalogi_docs||[]).push([[9246],{28453:(e,i,n)=>{n.d(i,{R:()=>s,x:()=>l});var t=n(96540);const r={},c=t.createContext(r);function s(e){const i=t.useContext(c);return t.useMemo((function(){return"function"==typeof e?e(i):{...i,...e}}),[i,e])}function l(e){let i;return i=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:s(e.components),t.createElement(c.Provider,{value:i},e.children)}},97355:(e,i,n)=>{n.r(i),n.d(i,{assets:()=>a,contentTitle:()=>l,default:()=>h,frontMatter:()=>s,metadata:()=>t,toc:()=>o});const t=JSON.parse('{"id":"Technical/vectorization-architecture","title":"Vectorization Architecture","description":"Overview","source":"@site/docs/Technical/vectorization-architecture.md","sourceDirName":"Technical","slug":"/Technical/vectorization-architecture","permalink":"/docs/Technical/vectorization-architecture","draft":false,"unlisted":false,"editUrl":"https://github.com/conductionnl/openregister/tree/main/website/docs/Technical/vectorization-architecture.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Search Trails","permalink":"/docs/Features/search-trails"},"next":{"title":"European Client Register","permalink":"/docs/UseCases/clientRegisters"}}');var r=n(74848),c=n(28453);const s={},l="Vectorization Architecture",a={},o=[{value:"Overview",id:"overview",level:2},{value:"Architecture",id:"architecture",level:2},{value:"Core Components",id:"core-components",level:3},{value:"1. VectorizationService",id:"1-vectorizationservice",level:3},{value:"2. VectorizationStrategyInterface",id:"2-vectorizationstrategyinterface",level:3},{value:"3. Strategies",id:"3-strategies",level:3},{value:"FileVectorizationStrategy",id:"filevectorizationstrategy",level:4},{value:"ObjectVectorizationStrategy",id:"objectvectorizationstrategy",level:4},{value:"Usage",id:"usage",level:2},{value:"File Vectorization",id:"file-vectorization",level:3},{value:"Object Vectorization",id:"object-vectorization",level:3},{value:"Adding New Entity Types",id:"adding-new-entity-types",level:2},{value:"1. Create Strategy",id:"1-create-strategy",level:3},{value:"2. Register Strategy",id:"2-register-strategy",level:3},{value:"3. Use It",id:"3-use-it",level:3},{value:"Benefits",id:"benefits",level:2},{value:"Code Reduction",id:"code-reduction",level:3},{value:"Consistency",id:"consistency",level:3},{value:"Extensibility",id:"extensibility",level:3},{value:"Maintainability",id:"maintainability",level:3},{value:"Implementation Details",id:"implementation-details",level:2},{value:"Dependency Injection",id:"dependency-injection",level:3},{value:"Processing Modes",id:"processing-modes",level:3},{value:"Migration from Old Services",id:"migration-from-old-services",level:2},{value:"Testing",id:"testing",level:2},{value:"Test Core Logic Once",id:"test-core-logic-once",level:3},{value:"Test Strategies Independently",id:"test-strategies-independently",level:3},{value:"Future Enhancements",id:"future-enhancements",level:2}];function d(e){const i={code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,c.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(i.header,{children:(0,r.jsx)(i.h1,{id:"vectorization-architecture",children:"Vectorization Architecture"})}),"\n",(0,r.jsx)(i.h2,{id:"overview",children:"Overview"}),"\n",(0,r.jsxs)(i.p,{children:["The OpenRegister app uses a unified vectorization architecture based on the ",(0,r.jsx)(i.strong,{children:"Strategy Pattern"})," to eliminate code duplication and provide a consistent API for vectorizing different entity types (files, objects, etc.)."]}),"\n",(0,r.jsx)(i.h2,{id:"architecture",children:"Architecture"}),"\n",(0,r.jsx)(i.h3,{id:"core-components",children:"Core Components"}),"\n",(0,r.jsx)(i.pre,{children:(0,r.jsx)(i.code,{children:"VectorizationService (Generic Core)\n    \u251c\u2500\u2500 VectorEmbeddingService (generates embeddings)\n    \u2514\u2500\u2500 Strategies (entity-specific logic):\n        \u251c\u2500\u2500 FileVectorizationStrategy\n        \u251c\u2500\u2500 ObjectVectorizationStrategy\n        \u2514\u2500\u2500 [Future strategies...]\n"})}),"\n",(0,r.jsx)(i.h3,{id:"1-vectorizationservice",children:"1. VectorizationService"}),"\n",(0,r.jsxs)(i.p,{children:[(0,r.jsx)(i.strong,{children:"Location:"})," 'lib/Service/VectorizationService.php'"]}),"\n",(0,r.jsx)(i.p,{children:(0,r.jsx)(i.strong,{children:"Responsibilities:"})}),"\n",(0,r.jsxs)(i.ul,{children:["\n",(0,r.jsx)(i.li,{children:"Batch processing with error handling"}),"\n",(0,r.jsx)(i.li,{children:"Serial and parallel mode support"}),"\n",(0,r.jsx)(i.li,{children:"Progress tracking"}),"\n",(0,r.jsx)(i.li,{children:"Embedding generation coordination"}),"\n",(0,r.jsx)(i.li,{children:"Vector storage coordination"}),"\n"]}),"\n",(0,r.jsx)(i.p,{children:(0,r.jsx)(i.strong,{children:"Key Method:"})}),"\n",(0,r.jsx)(i.pre,{children:(0,r.jsx)(i.code,{className:"language-php",children:"public function vectorizeBatch(string $entityType, array $options): array\n"})}),"\n",(0,r.jsx)(i.h3,{id:"2-vectorizationstrategyinterface",children:"2. VectorizationStrategyInterface"}),"\n",(0,r.jsxs)(i.p,{children:[(0,r.jsx)(i.strong,{children:"Location:"})," 'lib/Service/Vectorization/VectorizationStrategyInterface.php'"]}),"\n",(0,r.jsx)(i.p,{children:(0,r.jsx)(i.strong,{children:"Contract:"})}),"\n",(0,r.jsxs)(i.ul,{children:["\n",(0,r.jsx)(i.li,{children:"'fetchEntities()' - Get entities to vectorize"}),"\n",(0,r.jsx)(i.li,{children:"'extractVectorizationItems()' - Extract text items from entity"}),"\n",(0,r.jsx)(i.li,{children:"'prepareVectorMetadata()' - Prepare metadata for storage"}),"\n",(0,r.jsx)(i.li,{children:"'getEntityIdentifier()' - Get entity ID for logging"}),"\n"]}),"\n",(0,r.jsx)(i.h3,{id:"3-strategies",children:"3. Strategies"}),"\n",(0,r.jsx)(i.h4,{id:"filevectorizationstrategy",children:"FileVectorizationStrategy"}),"\n",(0,r.jsxs)(i.p,{children:[(0,r.jsx)(i.strong,{children:"Location:"})," 'lib/Service/Vectorization/FileVectorizationStrategy.php'"]}),"\n",(0,r.jsx)(i.p,{children:(0,r.jsx)(i.strong,{children:"File-specific logic:"})}),"\n",(0,r.jsxs)(i.ul,{children:["\n",(0,r.jsx)(i.li,{children:"Fetches files with completed extractions"}),"\n",(0,r.jsx)(i.li,{children:"Filters by MIME type"}),"\n",(0,r.jsx)(i.li,{children:"Extracts pre-chunked text from 'chunks_json'"}),"\n",(0,r.jsx)(i.li,{children:"Handles multiple chunks per file (1 file = N vectors)"}),"\n"]}),"\n",(0,r.jsx)(i.p,{children:(0,r.jsx)(i.strong,{children:"Options:"})}),"\n",(0,r.jsxs)(i.ul,{children:["\n",(0,r.jsx)(i.li,{children:"'max_files' - Maximum files to process (0 = all)"}),"\n",(0,r.jsx)(i.li,{children:"'file_types' - Array of MIME types to filter"}),"\n",(0,r.jsx)(i.li,{children:"'batch_size' - Chunks per batch"}),"\n",(0,r.jsx)(i.li,{children:"'mode' - 'serial' or 'parallel'"}),"\n"]}),"\n",(0,r.jsx)(i.h4,{id:"objectvectorizationstrategy",children:"ObjectVectorizationStrategy"}),"\n",(0,r.jsxs)(i.p,{children:[(0,r.jsx)(i.strong,{children:"Location:"})," 'lib/Service/Vectorization/ObjectVectorizationStrategy.php'"]}),"\n",(0,r.jsx)(i.p,{children:(0,r.jsx)(i.strong,{children:"Object-specific logic:"})}),"\n",(0,r.jsxs)(i.ul,{children:["\n",(0,r.jsx)(i.li,{children:"Fetches objects by views and schemas"}),"\n",(0,r.jsx)(i.li,{children:"Serializes object data to text"}),"\n",(0,r.jsx)(i.li,{children:"Handles single vector per object (1 object = 1 vector)"}),"\n"]}),"\n",(0,r.jsx)(i.p,{children:(0,r.jsx)(i.strong,{children:"Options:"})}),"\n",(0,r.jsxs)(i.ul,{children:["\n",(0,r.jsx)(i.li,{children:"'views' - Array of view IDs to filter (null = all)"}),"\n",(0,r.jsx)(i.li,{children:"'batch_size' - Objects per batch"}),"\n",(0,r.jsx)(i.li,{children:"'mode' - 'serial' or 'parallel'"}),"\n"]}),"\n",(0,r.jsx)(i.h2,{id:"usage",children:"Usage"}),"\n",(0,r.jsx)(i.h3,{id:"file-vectorization",children:"File Vectorization"}),"\n",(0,r.jsx)(i.pre,{children:(0,r.jsx)(i.code,{className:"language-php",children:"// In FileExtractionController\n$result = $this->vectorizationService->vectorizeBatch('file', [\n    'mode' => 'parallel',\n    'max_files' => 100,\n    'batch_size' => 50,\n    'file_types' => ['application/pdf', 'text/plain'],\n]);\n"})}),"\n",(0,r.jsx)(i.h3,{id:"object-vectorization",children:"Object Vectorization"}),"\n",(0,r.jsx)(i.pre,{children:(0,r.jsx)(i.code,{className:"language-php",children:"// In ObjectsController\n$result = $this->vectorizationService->vectorizeBatch('object', [\n    'mode' => 'serial',\n    'views' => [1, 2, 3],\n    'batch_size' => 25,\n]);\n"})}),"\n",(0,r.jsx)(i.h2,{id:"adding-new-entity-types",children:"Adding New Entity Types"}),"\n",(0,r.jsx)(i.p,{children:"To add vectorization for a new entity type (e.g., emails, chat messages):"}),"\n",(0,r.jsx)(i.h3,{id:"1-create-strategy",children:"1. Create Strategy"}),"\n",(0,r.jsx)(i.pre,{children:(0,r.jsx)(i.code,{className:"language-php",children:"namespace OCA\\OpenRegister\\Service\\Vectorization;\n\nclass EmailVectorizationStrategy implements VectorizationStrategyInterface\n{\n    public function fetchEntities(array $options): array\n    {\n        // Fetch emails to vectorize\n        return $this->emailMapper->findUnvectorized($options['limit'] ?? 100);\n    }\n    \n    public function extractVectorizationItems($email): array\n    {\n        // Extract text from email\n        return [[\n            'text' => $email->getSubject() . \"\\n\\n\" . $email->getBody(),\n            'index' => 0,\n        ]];\n    }\n    \n    public function prepareVectorMetadata($email, array $item): array\n    {\n        return [\n            'entity_type' => 'email',\n            'entity_id' => (string) $email->getId(),\n            'chunk_index' => 0,\n            'total_chunks' => 1,\n            'chunk_text' => substr($item['text'], 0, 500),\n            'additional_metadata' => [\n                'from' => $email->getFrom(),\n                'to' => $email->getTo(),\n                'subject' => $email->getSubject(),\n                'date' => $email->getDate(),\n            ],\n        ];\n    }\n    \n    public function getEntityIdentifier($email)\n    {\n        return $email->getId();\n    }\n}\n"})}),"\n",(0,r.jsx)(i.h3,{id:"2-register-strategy",children:"2. Register Strategy"}),"\n",(0,r.jsx)(i.p,{children:"In 'lib/AppInfo/Application.php':"}),"\n",(0,r.jsx)(i.pre,{children:(0,r.jsx)(i.code,{className:"language-php",children:"// Register EmailVectorizationStrategy\n$context->registerService(\n    EmailVectorizationStrategy::class,\n    function ($container) {\n        return new EmailVectorizationStrategy(\n            $container->get(EmailMapper::class),\n            $container->get('Psr\\Log\\LoggerInterface')\n        );\n    }\n);\n\n// Register with VectorizationService\n$service->registerStrategy('email', $container->get(EmailVectorizationStrategy::class));\n"})}),"\n",(0,r.jsx)(i.h3,{id:"3-use-it",children:"3. Use It"}),"\n",(0,r.jsx)(i.pre,{children:(0,r.jsx)(i.code,{className:"language-php",children:"$result = $vectorizationService->vectorizeBatch('email', [\n    'mode' => 'serial',\n    'limit' => 50,\n]);\n"})}),"\n",(0,r.jsx)(i.h2,{id:"benefits",children:"Benefits"}),"\n",(0,r.jsx)(i.h3,{id:"code-reduction",children:"Code Reduction"}),"\n",(0,r.jsxs)(i.ul,{children:["\n",(0,r.jsxs)(i.li,{children:[(0,r.jsx)(i.strong,{children:"Before:"})," 820 lines across two separate services"]}),"\n",(0,r.jsxs)(i.li,{children:[(0,r.jsx)(i.strong,{children:"After:"})," 350 lines core + ~150 lines per strategy"]}),"\n",(0,r.jsxs)(i.li,{children:[(0,r.jsx)(i.strong,{children:"Savings:"})," 40% less code for 2 entity types, more as we add types"]}),"\n"]}),"\n",(0,r.jsx)(i.h3,{id:"consistency",children:"Consistency"}),"\n",(0,r.jsxs)(i.ul,{children:["\n",(0,r.jsx)(i.li,{children:"Same batch processing for all entities"}),"\n",(0,r.jsx)(i.li,{children:"Same error handling"}),"\n",(0,r.jsx)(i.li,{children:"Same progress tracking"}),"\n",(0,r.jsx)(i.li,{children:"Same API structure"}),"\n"]}),"\n",(0,r.jsx)(i.h3,{id:"extensibility",children:"Extensibility"}),"\n",(0,r.jsxs)(i.ul,{children:["\n",(0,r.jsx)(i.li,{children:"New entity types require only ~150 lines"}),"\n",(0,r.jsx)(i.li,{children:"No modification to core logic"}),"\n",(0,r.jsx)(i.li,{children:"Easy to test independently"}),"\n"]}),"\n",(0,r.jsx)(i.h3,{id:"maintainability",children:"Maintainability"}),"\n",(0,r.jsxs)(i.ul,{children:["\n",(0,r.jsx)(i.li,{children:"Single source of truth for vectorization"}),"\n",(0,r.jsx)(i.li,{children:"Changes to core logic benefit all entities"}),"\n",(0,r.jsx)(i.li,{children:"Clear separation of concerns"}),"\n"]}),"\n",(0,r.jsx)(i.h2,{id:"implementation-details",children:"Implementation Details"}),"\n",(0,r.jsx)(i.h3,{id:"dependency-injection",children:"Dependency Injection"}),"\n",(0,r.jsx)(i.p,{children:"All services and strategies are registered in 'lib/AppInfo/Application.php':"}),"\n",(0,r.jsx)(i.pre,{children:(0,r.jsx)(i.code,{className:"language-php",children:"// VectorEmbeddingService (low-level embedding generation)\n$context->registerService(VectorEmbeddingService::class, ...);\n\n// Strategies\n$context->registerService(FileVectorizationStrategy::class, ...);\n$context->registerService(ObjectVectorizationStrategy::class, ...);\n\n// VectorizationService (unified API)\n$context->registerService(VectorizationService::class, function ($container) {\n    $service = new VectorizationService(\n        $container->get(VectorEmbeddingService::class),\n        $container->get('Psr\\Log\\LoggerInterface')\n    );\n    \n    // Register all strategies\n    $service->registerStrategy('file', $container->get(FileVectorizationStrategy::class));\n    $service->registerStrategy('object', $container->get(ObjectVectorizationStrategy::class));\n    \n    return $service;\n});\n"})}),"\n",(0,r.jsx)(i.h3,{id:"processing-modes",children:"Processing Modes"}),"\n",(0,r.jsx)(i.p,{children:(0,r.jsx)(i.strong,{children:"Serial Mode:"})}),"\n",(0,r.jsxs)(i.ul,{children:["\n",(0,r.jsx)(i.li,{children:"Process one item at a time"}),"\n",(0,r.jsx)(i.li,{children:"Lower memory usage"}),"\n",(0,r.jsx)(i.li,{children:"More predictable performance"}),"\n",(0,r.jsx)(i.li,{children:"Recommended for objects"}),"\n"]}),"\n",(0,r.jsx)(i.p,{children:(0,r.jsx)(i.strong,{children:"Parallel Mode:"})}),"\n",(0,r.jsxs)(i.ul,{children:["\n",(0,r.jsx)(i.li,{children:"Process items in batches"}),"\n",(0,r.jsx)(i.li,{children:"Higher throughput"}),"\n",(0,r.jsx)(i.li,{children:"More memory usage"}),"\n",(0,r.jsx)(i.li,{children:"Recommended for files (many chunks)"}),"\n"]}),"\n",(0,r.jsx)(i.h2,{id:"migration-from-old-services",children:"Migration from Old Services"}),"\n",(0,r.jsx)(i.p,{children:"The old separate services have been removed:"}),"\n",(0,r.jsxs)(i.ul,{children:["\n",(0,r.jsx)(i.li,{children:"\u274c 'FileVectorizationService.php' (355 lines) - DELETED"}),"\n",(0,r.jsx)(i.li,{children:"\u274c 'ObjectVectorizationService.php' (465 lines) - DELETED"}),"\n"]}),"\n",(0,r.jsx)(i.p,{children:"All functionality is now provided by:"}),"\n",(0,r.jsxs)(i.ul,{children:["\n",(0,r.jsx)(i.li,{children:"\u2705 'VectorizationService.php' (350 lines) - Generic core"}),"\n",(0,r.jsx)(i.li,{children:"\u2705 'FileVectorizationStrategy.php' (150 lines) - File-specific"}),"\n",(0,r.jsx)(i.li,{children:"\u2705 'ObjectVectorizationStrategy.php' (180 lines) - Object-specific"}),"\n"]}),"\n",(0,r.jsx)(i.p,{children:"The API has changed slightly:"}),"\n",(0,r.jsx)(i.p,{children:(0,r.jsx)(i.strong,{children:"Old API (deprecated):"})}),"\n",(0,r.jsx)(i.pre,{children:(0,r.jsx)(i.code,{className:"language-php",children:"$fileVectorizationService->startBatchVectorization($mode, $maxFiles, $batchSize, $fileTypes);\n$objectVectorizationService->startBatchVectorization($views, $batchSize);\n"})}),"\n",(0,r.jsx)(i.p,{children:(0,r.jsx)(i.strong,{children:"New API (current):"})}),"\n",(0,r.jsx)(i.pre,{children:(0,r.jsx)(i.code,{className:"language-php",children:"$vectorizationService->vectorizeBatch('file', [\n    'mode' => $mode,\n    'max_files' => $maxFiles,\n    'batch_size' => $batchSize,\n    'file_types' => $fileTypes,\n]);\n\n$vectorizationService->vectorizeBatch('object', [\n    'views' => $views,\n    'batch_size' => $batchSize,\n    'mode' => 'serial',\n]);\n"})}),"\n",(0,r.jsx)(i.h2,{id:"testing",children:"Testing"}),"\n",(0,r.jsx)(i.h3,{id:"test-core-logic-once",children:"Test Core Logic Once"}),"\n",(0,r.jsx)(i.pre,{children:(0,r.jsx)(i.code,{className:"language-php",children:"class VectorizationServiceTest extends TestCase {\n    public function testBatchProcessing() {\n        // Mock strategy\n        $strategy = $this->createMock(VectorizationStrategyInterface::class);\n        \n        // Test batch processing, error handling, etc.\n        $service->registerStrategy('test', $strategy);\n        $result = $service->vectorizeBatch('test', []);\n    }\n}\n"})}),"\n",(0,r.jsx)(i.h3,{id:"test-strategies-independently",children:"Test Strategies Independently"}),"\n",(0,r.jsx)(i.pre,{children:(0,r.jsx)(i.code,{className:"language-php",children:"class FileVectorizationStrategyTest extends TestCase {\n    public function testFetchEntities() {\n        // Test file filtering, MIME type handling, etc.\n    }\n    \n    public function testExtractChunks() {\n        // Test chunk extraction from JSON\n    }\n}\n"})}),"\n",(0,r.jsx)(i.h2,{id:"future-enhancements",children:"Future Enhancements"}),"\n",(0,r.jsx)(i.p,{children:"Potential new entity types to vectorize:"}),"\n",(0,r.jsxs)(i.ul,{children:["\n",(0,r.jsxs)(i.li,{children:["\ud83d\udce7 ",(0,r.jsx)(i.strong,{children:"Emails"})," - Subject + body vectorization"]}),"\n",(0,r.jsxs)(i.li,{children:["\ud83d\udcac ",(0,r.jsx)(i.strong,{children:"Chat messages"})," - Conversation context vectorization"]}),"\n",(0,r.jsxs)(i.li,{children:["\ud83d\udcdd ",(0,r.jsx)(i.strong,{children:"Comments"})," - User-generated content vectorization"]}),"\n",(0,r.jsxs)(i.li,{children:["\ud83c\udff7\ufe0f ",(0,r.jsx)(i.strong,{children:"Tags"})," - Semantic tag relationships"]}),"\n",(0,r.jsxs)(i.li,{children:["\ud83d\udcca ",(0,r.jsx)(i.strong,{children:"Reports"})," - Generated report content"]}),"\n"]}),"\n",(0,r.jsx)(i.p,{children:"Each requires only ~150 lines of strategy code!"})]})}function h(e={}){const{wrapper:i}={...(0,c.R)(),...e.components};return i?(0,r.jsx)(i,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}}}]);