"use strict";(self.webpackChunkopen_catalogi_docs=self.webpackChunkopen_catalogi_docs||[]).push([[5464],{28453:(e,n,l)=>{l.d(n,{R:()=>t,x:()=>d});var i=l(96540);const r={},s=i.createContext(r);function t(e){const n=i.useContext(s);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:t(e.components),i.createElement(s.Provider,{value:n},e.children)}},49169:(e,n,l)=>{l.r(n),l.d(n,{assets:()=>o,contentTitle:()=>d,default:()=>h,frontMatter:()=>t,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"fixes/FOLDER_DELETION_FIX","title":"Folder Deletion Fix","description":"Fix for import errors when reusing UUIDs due to orphaned folders","source":"@site/docs/fixes/FOLDER_DELETION_FIX.md","sourceDirName":"fixes","slug":"/fixes/FOLDER_DELETION_FIX","permalink":"/docs/fixes/FOLDER_DELETION_FIX","draft":false,"unlisted":false,"editUrl":"https://github.com/conductionnl/openregister/tree/main/website/docs/fixes/FOLDER_DELETION_FIX.md","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"sidebar_position":3,"title":"Folder Deletion Fix","description":"Fix for import errors when reusing UUIDs due to orphaned folders"},"sidebar":"tutorialSidebar","previous":{"title":"Organisation Default Fix","permalink":"/docs/fixes/ORGANISATION_DEFAULT_FIX"},"next":{"title":"Bulk Import Deduplication System - Current Status","permalink":"/docs/fixes/BULK_IMPORT_STATUS"}}');var r=l(74848),s=l(28453);const t={sidebar_position:3,title:"Folder Deletion Fix",description:"Fix for import errors when reusing UUIDs due to orphaned folders"},d="Folder Deletion Fix Summary",o={},c=[{value:"Problem Description",id:"problem-description",level:2},{value:"Root Cause",id:"root-cause",level:2},{value:"Solution Implemented",id:"solution-implemented",level:2},{value:"1. <strong>Enhanced Folder Deletion for Hard Deletes</strong>",id:"1-enhanced-folder-deletion-for-hard-deletes",level:3},{value:"2. <strong>Improved Multiple Folder Handling</strong>",id:"2-improved-multiple-folder-handling",level:3},{value:"3. <strong>Added Cleanup TODO</strong>",id:"3-added-cleanup-todo",level:3},{value:"Files Modified",id:"files-modified",level:2},{value:"Core Files",id:"core-files",level:3},{value:"Dependencies Added",id:"dependencies-added",level:3},{value:"Database Impact",id:"database-impact",level:2},{value:"API Changes",id:"api-changes",level:2},{value:"Testing Scenarios",id:"testing-scenarios",level:2},{value:"\u2705 <strong>Hard Delete with Folder Cleanup</strong>",id:"-hard-delete-with-folder-cleanup",level:3},{value:"\u2705 <strong>Multiple Folder Resolution</strong>",id:"-multiple-folder-resolution",level:3},{value:"\u2705 <strong>Error Handling</strong>",id:"-error-handling",level:3},{value:"Future Improvements",id:"future-improvements",level:2},{value:"<strong>Nightly Cleanup Cron Job</strong>",id:"nightly-cleanup-cron-job",level:3},{value:"<strong>Implementation Suggestions</strong>",id:"implementation-suggestions",level:3},{value:"Deployment Instructions",id:"deployment-instructions",level:2},{value:"Impact",id:"impact",level:2}];function a(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"folder-deletion-fix-summary",children:"Folder Deletion Fix Summary"})}),"\n",(0,r.jsx)(n.h2,{id:"problem-description",children:"Problem Description"}),"\n",(0,r.jsx)(n.p,{children:"When importing new objects with a UUID that was previously deleted from the system, the following error occurred:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"Multiple nodes found in oc_filecache with name equal to object uuid: 81efcfa2-25ca-4cd5-a320-6b9efad2eb04\n"})}),"\n",(0,r.jsx)(n.p,{children:"This happened because:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["When the original object was created, ",(0,r.jsx)(n.code,{children:"ObjectService.php"})," and ",(0,r.jsx)(n.code,{children:"FileService.php"})," created a folder"]}),"\n",(0,r.jsx)(n.li,{children:"During the delete object phase, the folder wasn't deleted (only soft deleted)"}),"\n",(0,r.jsx)(n.li,{children:"When reusing the same UUID, the system found multiple folders with the same name"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"root-cause",children:"Root Cause"}),"\n",(0,r.jsx)(n.p,{children:"The folder deletion was incomplete:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Soft deletes"})," (objects marked as deleted but not removed) kept folders intact"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Hard deletes"})," (permanent removal) didn't clean up the object folders"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Multiple folders"})," with the same UUID name caused conflicts during import"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"solution-implemented",children:"Solution Implemented"}),"\n",(0,r.jsxs)(n.h3,{id:"1-enhanced-folder-deletion-for-hard-deletes",children:["1. ",(0,r.jsx)(n.strong,{children:"Enhanced Folder Deletion for Hard Deletes"})]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"File"}),": ",(0,r.jsx)(n.code,{children:"lib/Service/ObjectHandlers/DeleteObject.php"})]}),"\n",(0,r.jsx)(n.p,{children:"Added folder deletion to the hard delete process:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"/**\n * Delete the object folder when performing hard delete\n *\n * @param ObjectEntity $objectEntity The object entity to delete folder for\n *\n * @return void\n */\nprivate function deleteObjectFolder(ObjectEntity $objectEntity): void\n{\n    try {\n        $folder = $this->fileService->getObjectFolder($objectEntity);\n        if ($folder !== null) {\n            $folder->delete();\n            $this->logger->info('Deleted object folder for hard deleted object: ' . $objectEntity->getId());\n        }\n    } catch (\\Exception $e) {\n        // Log error but don't fail the deletion process\n        $this->logger->warning('Failed to delete object folder for object ' . $objectEntity->getId() . ': ' . $e->getMessage());\n    }\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Changes"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Added ",(0,r.jsx)(n.code,{children:"deleteObjectFolder()"})," method to handle folder cleanup"]}),"\n",(0,r.jsxs)(n.li,{children:["Integrated folder deletion into the main ",(0,r.jsx)(n.code,{children:"delete()"})," method"]}),"\n",(0,r.jsx)(n.li,{children:"Added proper error handling to prevent deletion failures"}),"\n",(0,r.jsx)(n.li,{children:"Added logging for successful deletions and errors"}),"\n"]}),"\n",(0,r.jsxs)(n.h3,{id:"2-improved-multiple-folder-handling",children:["2. ",(0,r.jsx)(n.strong,{children:"Improved Multiple Folder Handling"})]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"File"}),": ",(0,r.jsx)(n.code,{children:"lib/Db/FileMapper.php"})]}),"\n",(0,r.jsx)(n.p,{children:"Changed error handling to pick the oldest folder instead of throwing an error:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"// Before: Throw error on multiple folders\n} elseif ($count > 1) {\n    throw new \\RuntimeException('Multiple nodes found in oc_filecache with name equal to object uuid: ' . $uuid);\n}\n\n// After: Pick oldest folder (lowest fileid)\n} elseif ($count > 1) {\n    // Multiple folders found with same UUID - pick the oldest one (lowest fileid)\n    // TODO: Add nightly cron job to cleanup orphaned folders and logs\n    usort($rows, function($a, $b) {\n        return (int) $a['fileid'] - (int) $b['fileid'];\n    });\n    $oldestNodeId = (int) $rows[0]['fileid'];\n    return $this->getFiles($oldestNodeId);\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Changes"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Replaced error throwing with intelligent folder selection"}),"\n",(0,r.jsxs)(n.li,{children:["Sort folders by ",(0,r.jsx)(n.code,{children:"fileid"})," (creation order) to pick the oldest"]}),"\n",(0,r.jsx)(n.li,{children:"Added TODO comment for future cleanup improvements"}),"\n"]}),"\n",(0,r.jsxs)(n.h3,{id:"3-added-cleanup-todo",children:["3. ",(0,r.jsx)(n.strong,{children:"Added Cleanup TODO"})]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"File"}),": ",(0,r.jsx)(n.code,{children:"lib/Service/ObjectService.php"})]}),"\n",(0,r.jsx)(n.p,{children:"Added TODO comment for future nightly cleanup implementation:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function delete(array | JsonSerializable $object): bool\n{\n    // TODO: Add nightly cron job to cleanup orphaned folders and logs\n    // This should scan for folders without corresponding objects and clean them up\n    return $this->deleteHandler->delete($object);\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"files-modified",children:"Files Modified"}),"\n",(0,r.jsx)(n.h3,{id:"core-files",children:"Core Files"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.code,{children:"lib/Service/ObjectHandlers/DeleteObject.php"})})," - Added folder deletion for hard deletes"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.code,{children:"lib/Db/FileMapper.php"})})," - Improved multiple folder handling"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.code,{children:"lib/Service/ObjectService.php"})})," - Added cleanup TODO"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"dependencies-added",children:"Dependencies Added"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"LoggerInterface"})," - Added to DeleteObject for proper error logging"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"database-impact",children:"Database Impact"}),"\n",(0,r.jsx)(n.p,{children:"No database schema changes required. The fixes work with existing data structures."}),"\n",(0,r.jsx)(n.h2,{id:"api-changes",children:"API Changes"}),"\n",(0,r.jsx)(n.p,{children:"No API changes. The fixes are internal improvements that maintain backward compatibility."}),"\n",(0,r.jsx)(n.h2,{id:"testing-scenarios",children:"Testing Scenarios"}),"\n",(0,r.jsx)(n.p,{children:"The fixes address the following scenarios:"}),"\n",(0,r.jsxs)(n.h3,{id:"-hard-delete-with-folder-cleanup",children:["\u2705 ",(0,r.jsx)(n.strong,{children:"Hard Delete with Folder Cleanup"})]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Object is permanently deleted"}),"\n",(0,r.jsx)(n.li,{children:"Associated folder is automatically removed"}),"\n",(0,r.jsx)(n.li,{children:"No orphaned folders left behind"}),"\n"]}),"\n",(0,r.jsxs)(n.h3,{id:"-multiple-folder-resolution",children:["\u2705 ",(0,r.jsx)(n.strong,{children:"Multiple Folder Resolution"})]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Import with previously used UUID"}),"\n",(0,r.jsx)(n.li,{children:"System picks oldest folder instead of erroring"}),"\n",(0,r.jsx)(n.li,{children:"Import completes successfully"}),"\n"]}),"\n",(0,r.jsxs)(n.h3,{id:"-error-handling",children:["\u2705 ",(0,r.jsx)(n.strong,{children:"Error Handling"})]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Folder deletion failures don't break object deletion"}),"\n",(0,r.jsx)(n.li,{children:"Proper logging for debugging"}),"\n",(0,r.jsx)(n.li,{children:"Graceful degradation"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"future-improvements",children:"Future Improvements"}),"\n",(0,r.jsx)(n.h3,{id:"nightly-cleanup-cron-job",children:(0,r.jsx)(n.strong,{children:"Nightly Cleanup Cron Job"})}),"\n",(0,r.jsx)(n.p,{children:"The TODO comment indicates the need for a nightly cleanup job that should:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Scan for orphaned folders"})," - Find folders without corresponding objects"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Clean up orphaned logs"})," - Remove audit trails for non-existent objects"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Report cleanup statistics"})," - Log what was cleaned up"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Handle edge cases"})," - Deal with partially deleted objects"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"implementation-suggestions",children:(0,r.jsx)(n.strong,{children:"Implementation Suggestions"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"// Example cleanup job structure\nclass CleanupService\n{\n    public function cleanupOrphanedFolders(): array\n    {\n        // Find folders without objects\n        // Delete orphaned folders\n        // Return cleanup statistics\n    }\n    \n    public function cleanupOrphanedLogs(): array\n    {\n        // Find logs for non-existent objects\n        // Clean up orphaned audit trails\n        // Return cleanup statistics\n    }\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"deployment-instructions",children:"Deployment Instructions"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Deploy the code changes"})," to production"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Test import functionality"})," with previously deleted UUIDs"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Verify hard deletes"})," clean up folders properly"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Monitor logs"})," for any folder deletion issues"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Plan nightly cleanup job"})," implementation"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"impact",children:"Impact"}),"\n",(0,r.jsx)(n.p,{children:"This fix resolves the import error and ensures:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\u2705 ",(0,r.jsx)(n.strong,{children:"Import functionality works"})," with reused UUIDs"]}),"\n",(0,r.jsxs)(n.li,{children:["\u2705 ",(0,r.jsx)(n.strong,{children:"Hard deletes clean up"})," all associated resources"]}),"\n",(0,r.jsxs)(n.li,{children:["\u2705 ",(0,r.jsx)(n.strong,{children:"No orphaned folders"})," left in the system"]}),"\n",(0,r.jsxs)(n.li,{children:["\u2705 ",(0,r.jsx)(n.strong,{children:"Better error handling"})," for edge cases"]}),"\n",(0,r.jsxs)(n.li,{children:["\u2705 ",(0,r.jsx)(n.strong,{children:"Foundation for future cleanup"})," automation"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"The solution maintains backward compatibility while improving the robustness of the deletion and import processes."})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(a,{...e})}):a(e)}}}]);