"use strict";(self.webpackChunkopen_catalogi_docs=self.webpackChunkopen_catalogi_docs||[]).push([[5618],{28453:(e,n,i)=>{i.d(n,{R:()=>a,x:()=>l});var s=i(96540);const t={},r=s.createContext(t);function a(e){const n=s.useContext(r);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:a(e.components),s.createElement(r.Provider,{value:n},e.children)}},71524:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>o,contentTitle:()=>l,default:()=>h,frontMatter:()=>a,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"development/rbac","title":"RBAC and Multi-Tenancy","description":"Implementing Role-Based Access Control and Multi-Tenancy in Mappers","source":"@site/docs/development/rbac.md","sourceDirName":"development","slug":"/development/rbac","permalink":"/docs/development/rbac","draft":false,"unlisted":false,"editUrl":"https://github.com/conductionnl/openregister/tree/main/website/docs/development/rbac.md","tags":[],"version":"current","sidebarPosition":10,"frontMatter":{"sidebar_position":10,"title":"RBAC and Multi-Tenancy","description":"Implementing Role-Based Access Control and Multi-Tenancy in Mappers"},"sidebar":"tutorialSidebar","previous":{"title":"Tool Testing Guide","permalink":"/docs/development/tool-registration-testing"},"next":{"title":"Testing","permalink":"/docs/development/testing"}}');var t=i(74848),r=i(28453);const a={sidebar_position:10,title:"RBAC and Multi-Tenancy",description:"Implementing Role-Based Access Control and Multi-Tenancy in Mappers"},l="RBAC and Multi-Tenancy Implementation",o={},c=[{value:"Overview",id:"overview",level:2},{value:"Architecture",id:"architecture",level:2},{value:"Components",id:"components",level:3},{value:"Implementation Steps",id:"implementation-steps",level:2},{value:"Step 1: Add Organisation Property to Entity",id:"step-1-add-organisation-property-to-entity",level:3},{value:"Step 2: Add Database Column",id:"step-2-add-database-column",level:3},{value:"Step 3: Update Mapper to Use Trait",id:"step-3-update-mapper-to-use-trait",level:3},{value:"RBAC Configuration",id:"rbac-configuration",level:2},{value:"Organisation Roles Structure",id:"organisation-roles-structure",level:3},{value:"Entity Types",id:"entity-types",level:3},{value:"Actions",id:"actions",level:3},{value:"Trait Methods Reference",id:"trait-methods-reference",level:2},{value:"getActiveOrganisationUuid()",id:"getactiveorganisationuuid",level:3},{value:"getCurrentUserId()",id:"getcurrentuserid",level:3},{value:"isCurrentUserAdmin()",id:"iscurrentuseradmin",level:3},{value:"applyOrganisationFilter()",id:"applyorganisationfilter",level:3},{value:"setOrganisationOnCreate()",id:"setorganisationoncreate",level:3},{value:"verifyOrganisationAccess()",id:"verifyorganisationaccess",level:3},{value:"hasRbacPermission()",id:"hasrbacpermission",level:3},{value:"verifyRbacPermission()",id:"verifyrbacpermission",level:3},{value:"Best Practices",id:"best-practices",level:2},{value:"1. Always Inject Dependencies",id:"1-always-inject-dependencies",level:3},{value:"2. Apply Organisation Filter on All Reads",id:"2-apply-organisation-filter-on-all-reads",level:3},{value:"3. Verify Permissions on All Operations",id:"3-verify-permissions-on-all-operations",level:3},{value:"4. Verify Organisation on Modifications",id:"4-verify-organisation-on-modifications",level:3},{value:"5. Auto-Set Organisation on Create",id:"5-auto-set-organisation-on-create",level:3},{value:"6. Handle Exceptions in Controllers",id:"6-handle-exceptions-in-controllers",level:3},{value:"7. Admin Privileges",id:"7-admin-privileges",level:3},{value:"8. Default Organisation",id:"8-default-organisation",level:3},{value:"Testing",id:"testing",level:2},{value:"Test Cases to Cover",id:"test-cases-to-cover",level:3},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Issue: Organisation filter not applied",id:"issue-organisation-filter-not-applied",level:3},{value:"Issue: Users can&#39;t see their own entities",id:"issue-users-cant-see-their-own-entities",level:3},{value:"Issue: Admin can&#39;t access entities",id:"issue-admin-cant-access-entities",level:3},{value:"Issue: RBAC always denies access",id:"issue-rbac-always-denies-access",level:3},{value:"Related Documentation",id:"related-documentation",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"rbac-and-multi-tenancy-implementation",children:"RBAC and Multi-Tenancy Implementation"})}),"\n",(0,t.jsx)(n.p,{children:"This guide explains how to implement multi-tenancy and Role-Based Access Control (RBAC) in OpenRegister mappers using the 'MultiTenancyTrait'."}),"\n",(0,t.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,t.jsx)(n.p,{children:"OpenRegister uses a trait-based approach to provide consistent multi-tenancy and RBAC functionality across all mappers. This ensures that:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Users only see data from their active organisation"}),"\n",(0,t.jsx)(n.li,{children:"Permissions are checked before CRUD operations"}),"\n",(0,t.jsx)(n.li,{children:"Code duplication is minimized"}),"\n",(0,t.jsx)(n.li,{children:"Security is enforced at the database layer"}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"architecture",children:"Architecture"}),"\n",(0,t.jsx)(n.h3,{id:"components",children:"Components"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"MultiTenancyTrait"})," ('lib/Db/MultiTenancyTrait.php'): Reusable trait providing:"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Organisation filtering on reads"}),"\n",(0,t.jsx)(n.li,{children:"Auto-set organisation on creates"}),"\n",(0,t.jsx)(n.li,{children:"Organisation verification on updates/deletes"}),"\n",(0,t.jsx)(n.li,{children:"RBAC permission checking"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"OrganisationService"})," ('lib/Service/OrganisationService.php'): Manages:"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Active organisation in user session"}),"\n",(0,t.jsx)(n.li,{children:"Organisation membership"}),"\n",(0,t.jsx)(n.li,{children:"Default organisation"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Organisation Entity"})," ('lib/Db/Organisation.php'): Contains:"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"RBAC roles configuration"}),"\n",(0,t.jsx)(n.li,{children:"User membership"}),"\n",(0,t.jsx)(n.li,{children:"Permission definitions"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"implementation-steps",children:"Implementation Steps"}),"\n",(0,t.jsx)(n.h3,{id:"step-1-add-organisation-property-to-entity",children:"Step 1: Add Organisation Property to Entity"}),"\n",(0,t.jsx)(n.p,{children:"Each entity must have an 'organisation' property storing the organisation UUID:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-php",children:"<?php\nnamespace OCA\\OpenRegister\\Db;\n\nuse OCP\\AppFramework\\Db\\Entity;\n\n/**\n * @method string|null getOrganisation()\n * @method void setOrganisation(?string $organisation)\n */\nclass YourEntity extends Entity\n{\n    /**\n     * Organisation UUID this entity belongs to\n     *\n     * @var string|null\n     */\n    protected ?string $organisation = null;\n    \n    public function __construct() {\n        $this->addType('organisation', 'string');\n    }\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"step-2-add-database-column",children:"Step 2: Add Database Column"}),"\n",(0,t.jsx)(n.p,{children:"Create a migration to add the 'organisation' column:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-php",children:"<?php\nnamespace OCA\\OpenRegister\\Migration;\n\nuse OCP\\DB\\ISchemaWrapper;\nuse OCP\\Migration\\SimpleMigrationStep;\nuse OCP\\Migration\\IOutput;\n\nclass VersionXDateYYYYMMDDHHIISS extends SimpleMigrationStep\n{\n    public function changeSchema(IOutput $output, \\Closure $schemaClosure, array $options): ?ISchemaWrapper\n    {\n        /** @var ISchemaWrapper $schema */\n        $schema = $schemaClosure();\n        \n        if ($schema->hasTable('openregister_your_table')) {\n            $table = $schema->getTable('openregister_your_table');\n            \n            if (!$table->hasColumn('organisation')) {\n                $table->addColumn('organisation', 'string', [\n                    'notnull' => false,\n                    'length'  => 255,\n                    'default' => null,\n                ]);\n                \n                // Add index for faster filtering\n                $table->addIndex(['organisation'], 'your_table_organisation_idx');\n            }\n        }\n        \n        return $schema;\n    }\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"step-3-update-mapper-to-use-trait",children:"Step 3: Update Mapper to Use Trait"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-php",children:"<?php\nnamespace OCA\\OpenRegister\\Db;\n\nuse OCP\\AppFramework\\Db\\QBMapper;\nuse OCP\\IDBConnection;\nuse OCP\\IUserSession;\nuse OCP\\IGroupManager;\nuse OCA\\OpenRegister\\Service\\OrganisationService;\n\nclass YourMapper extends QBMapper\n{\n    use MultiTenancyTrait;\n    \n    private OrganisationService $organisationService;\n    private IUserSession $userSession;\n    private IGroupManager $groupManager;\n    \n    public function __construct(\n        IDBConnection $db,\n        OrganisationService $organisationService,\n        IUserSession $userSession,\n        IGroupManager $groupManager\n    ) {\n        parent::__construct($db, 'openregister_your_table', YourEntity::class);\n        $this->organisationService = $organisationService;\n        $this->userSession         = $userSession;\n        $this->groupManager        = $groupManager;\n    }\n    \n    public function insert(Entity $entity): Entity\n    {\n        // Verify RBAC permission to create\n        $this->verifyRbacPermission('create', 'your_entity_type');\n        \n        // Auto-set organisation from active session\n        $this->setOrganisationOnCreate($entity);\n        \n        return parent::insert($entity);\n    }\n    \n    public function update(Entity $entity): Entity\n    {\n        // Verify RBAC permission to update\n        $this->verifyRbacPermission('update', 'your_entity_type');\n        \n        // Verify user has access to this organisation\n        $this->verifyOrganisationAccess($entity);\n        \n        return parent::update($entity);\n    }\n    \n    public function delete(Entity $entity): Entity\n    {\n        // Verify RBAC permission to delete\n        $this->verifyRbacPermission('delete', 'your_entity_type');\n        \n        // Verify user has access to this organisation\n        $this->verifyOrganisationAccess($entity);\n        \n        return parent::delete($entity);\n    }\n    \n    public function find(int $id): YourEntity\n    {\n        // Verify RBAC permission to read\n        $this->verifyRbacPermission('read', 'your_entity_type');\n        \n        $qb = $this->db->getQueryBuilder();\n        $qb->select('*')\n            ->from($this->tableName)\n            ->where($qb->expr()->eq('id', $qb->createNamedParameter($id, IQueryBuilder::PARAM_INT)));\n        \n        // Apply organisation filter (all users including admins must have active org)\n        $this->applyOrganisationFilter($qb);\n        \n        return $this->findEntity($qb);\n    }\n    \n    public function findAll(int $limit = 50, int $offset = 0): array\n    {\n        // Verify RBAC permission to read\n        $this->verifyRbacPermission('read', 'your_entity_type');\n        \n        $qb = $this->db->getQueryBuilder();\n        $qb->select('*')\n            ->from($this->tableName)\n            ->setMaxResults($limit)\n            ->setFirstResult($offset)\n            ->orderBy('created', 'DESC');\n        \n        // Apply organisation filter\n        $this->applyOrganisationFilter($qb);\n        \n        return $this->findEntities($qb);\n    }\n}\n"})}),"\n",(0,t.jsx)(n.h2,{id:"rbac-configuration",children:"RBAC Configuration"}),"\n",(0,t.jsx)(n.h3,{id:"organisation-roles-structure",children:"Organisation Roles Structure"}),"\n",(0,t.jsx)(n.p,{children:"Organisations store RBAC configuration in their 'roles' JSON field:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n  "admin": {\n    "name": "Administrator",\n    "permissions": {\n      "*": ["*"]\n    }\n  },\n  "editor": {\n    "name": "Editor",\n    "permissions": {\n      "schema": ["create", "read", "update"],\n      "register": ["create", "read", "update"],\n      "configuration": ["read"]\n    }\n  },\n  "viewer": {\n    "name": "Viewer",\n    "permissions": {\n      "schema": ["read"],\n      "register": ["read"],\n      "configuration": ["read"]\n    }\n  }\n}\n'})}),"\n",(0,t.jsx)(n.h3,{id:"entity-types",children:"Entity Types"}),"\n",(0,t.jsx)(n.p,{children:"Supported entity types for RBAC:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"'schema'"}),"\n",(0,t.jsx)(n.li,{children:"'register'"}),"\n",(0,t.jsx)(n.li,{children:"'configuration'"}),"\n",(0,t.jsx)(n.li,{children:"'application'"}),"\n",(0,t.jsx)(n.li,{children:"'agent'"}),"\n",(0,t.jsx)(n.li,{children:"'view'"}),"\n",(0,t.jsx)(n.li,{children:"'source'"}),"\n",(0,t.jsx)(n.li,{children:"'organisation'"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"actions",children:"Actions"}),"\n",(0,t.jsx)(n.p,{children:"Supported CRUD actions:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"'create'"}),"\n",(0,t.jsx)(n.li,{children:"'read'"}),"\n",(0,t.jsx)(n.li,{children:"'update'"}),"\n",(0,t.jsx)(n.li,{children:"'delete'"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"Wildcard '*' grants all permissions."}),"\n",(0,t.jsx)(n.h2,{id:"trait-methods-reference",children:"Trait Methods Reference"}),"\n",(0,t.jsx)(n.h3,{id:"getactiveorganisationuuid",children:"getActiveOrganisationUuid()"}),"\n",(0,t.jsx)(n.p,{children:"Gets the active organisation UUID from the session."}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Returns:"})," 'string|null'"]}),"\n",(0,t.jsx)(n.h3,{id:"getcurrentuserid",children:"getCurrentUserId()"}),"\n",(0,t.jsx)(n.p,{children:"Gets the current logged-in user ID."}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Returns:"})," 'string|null'"]}),"\n",(0,t.jsx)(n.h3,{id:"iscurrentuseradmin",children:"isCurrentUserAdmin()"}),"\n",(0,t.jsx)(n.p,{children:"Checks if the current user is in the admin group."}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Returns:"})," 'bool'"]}),"\n",(0,t.jsx)(n.h3,{id:"applyorganisationfilter",children:"applyOrganisationFilter()"}),"\n",(0,t.jsx)(n.p,{children:"Applies organisation filtering to a query builder."}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Parameters:"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"'$qb': The query builder to modify"}),"\n",(0,t.jsx)(n.li,{children:"'$columnName': The column name for organisation (default: 'organisation')"}),"\n",(0,t.jsx)(n.li,{children:"'$allowNullOrg': Whether to include entities with null organisation"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Behavior:"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"All users (including admins) see only entities from their active organisation"}),"\n",(0,t.jsx)(n.li,{children:"Admins must set an active organisation to access data"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"setorganisationoncreate",children:"setOrganisationOnCreate()"}),"\n",(0,t.jsx)(n.p,{children:"Auto-sets the organisation UUID on entity creation."}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Usage:"})," Call in 'insert()' method before 'parent::insert()'"]}),"\n",(0,t.jsx)(n.h3,{id:"verifyorganisationaccess",children:"verifyOrganisationAccess()"}),"\n",(0,t.jsx)(n.p,{children:"Verifies that the entity belongs to the active organisation."}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Throws:"})," '\\Exception' if organisation doesn't match (HTTP 403)"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Usage:"})," Call in 'update()' and 'delete()' methods"]}),"\n",(0,t.jsx)(n.h3,{id:"hasrbacpermission",children:"hasRbacPermission()"}),"\n",(0,t.jsx)(n.p,{children:"Checks if the current user has RBAC permission."}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Returns:"})," 'bool'"]}),"\n",(0,t.jsx)(n.h3,{id:"verifyrbacpermission",children:"verifyRbacPermission()"}),"\n",(0,t.jsx)(n.p,{children:"Verifies RBAC permission and throws exception if denied."}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Throws:"})," '\\Exception' if permission denied (HTTP 403)"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Usage:"})," Call at the start of CRUD methods"]}),"\n",(0,t.jsx)(n.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,t.jsx)(n.h3,{id:"1-always-inject-dependencies",children:"1. Always Inject Dependencies"}),"\n",(0,t.jsx)(n.p,{children:"Ensure your mapper constructor injects:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"'OrganisationService'"}),"\n",(0,t.jsx)(n.li,{children:"'IUserSession'"}),"\n",(0,t.jsx)(n.li,{children:"'IGroupManager'"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"2-apply-organisation-filter-on-all-reads",children:"2. Apply Organisation Filter on All Reads"}),"\n",(0,t.jsx)(n.p,{children:"Apply 'applyOrganisationFilter()' to all query builders that fetch data."}),"\n",(0,t.jsx)(n.h3,{id:"3-verify-permissions-on-all-operations",children:"3. Verify Permissions on All Operations"}),"\n",(0,t.jsx)(n.p,{children:"Call 'verifyRbacPermission()' at the start of:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"'insert()' \u2192 'create'"}),"\n",(0,t.jsx)(n.li,{children:"'find()'/'findAll()' \u2192 'read'"}),"\n",(0,t.jsx)(n.li,{children:"'update()' \u2192 'update'"}),"\n",(0,t.jsx)(n.li,{children:"'delete()' \u2192 'delete'"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"4-verify-organisation-on-modifications",children:"4. Verify Organisation on Modifications"}),"\n",(0,t.jsx)(n.p,{children:"Call 'verifyOrganisationAccess()' in:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"'update()'"}),"\n",(0,t.jsx)(n.li,{children:"'delete()'"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"5-auto-set-organisation-on-create",children:"5. Auto-Set Organisation on Create"}),"\n",(0,t.jsx)(n.p,{children:"Call 'setOrganisationOnCreate()' in 'insert()' before 'parent::insert()'."}),"\n",(0,t.jsx)(n.h3,{id:"6-handle-exceptions-in-controllers",children:"6. Handle Exceptions in Controllers"}),"\n",(0,t.jsx)(n.p,{children:"Wrap mapper calls in try-catch blocks:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-php",children:"try {\n    $entity = $this->mapper->update($entity);\n    return new JSONResponse($entity, Response::HTTP_OK);\n} catch (\\Exception $e) {\n    if ($e->getCode() === Response::HTTP_FORBIDDEN) {\n        return new JSONResponse(['error' => $e->getMessage()], Response::HTTP_FORBIDDEN);\n    }\n    return new JSONResponse(['error' => 'Internal error'], Response::HTTP_INTERNAL_SERVER_ERROR);\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"7-admin-privileges",children:"7. Admin Privileges"}),"\n",(0,t.jsx)(n.p,{children:"Admins (users in the 'admin' group) have special privileges:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"RBAC Bypass"}),": Admins bypass all RBAC permission checks (create, read, update, delete)"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Organisation Access"}),": Admins can see ALL organisations and set ANY organisation as active"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Data Filtering"}),": Once an admin sets an active organisation, they ONLY see data from that organisation (no bypass)"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"This ensures admins work within an organisational context while having full permissions within that context."}),"\n",(0,t.jsx)(n.h3,{id:"8-default-organisation",children:"8. Default Organisation"}),"\n",(0,t.jsx)(n.p,{children:"Users without organisations are automatically added to the default organisation on first access."}),"\n",(0,t.jsx)(n.h2,{id:"testing",children:"Testing"}),"\n",(0,t.jsx)(n.h3,{id:"test-cases-to-cover",children:"Test Cases to Cover"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Create"}),": Entity gets organisation UUID set automatically (from active org)"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Read (Admin with Active Org)"}),": Admin sees only data from active organisation"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Read (User)"}),": User sees only data from their active organisation"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Update (Same Org)"}),": Succeeds (admin bypasses RBAC, user needs permission)"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Update (Different Org)"}),": Fails with 403 (for both admin and user)"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Delete (Same Org)"}),": Succeeds"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Delete (Different Org)"}),": Fails with 403"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"RBAC Create"}),": Only users with 'create' permission can create"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"RBAC Read"}),": Only users with 'read' permission can read"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"RBAC Update"}),": Only users with 'update' permission can update"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"RBAC Delete"}),": Only users with 'delete' permission can delete"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,t.jsx)(n.h3,{id:"issue-organisation-filter-not-applied",children:"Issue: Organisation filter not applied"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Cause:"})," Missing 'applyOrganisationFilter()' call in query builder"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Solution:"})," Add '$this->applyOrganisationFilter($qb)' to all find methods"]}),"\n",(0,t.jsx)(n.h3,{id:"issue-users-cant-see-their-own-entities",children:"Issue: Users can't see their own entities"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Cause:"})," Organisation UUID not set on entity creation"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Solution:"})," Ensure 'setOrganisationOnCreate()' is called in 'insert()'"]}),"\n",(0,t.jsx)(n.h3,{id:"issue-admin-cant-access-entities",children:"Issue: Admin can't access entities"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Cause:"})," Admin doesn't have an active organisation set"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Solution:"})," Admins must set an active organisation to access data. Check that 'OrganisationService.getActiveOrganisation()' returns a valid organisation."]}),"\n",(0,t.jsx)(n.h3,{id:"issue-rbac-always-denies-access",children:"Issue: RBAC always denies access"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Cause:"})," Roles not configured in organisation or incorrect structure"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Solution:"})," Check organisation's 'roles' field has proper structure"]}),"\n",(0,t.jsx)(n.h2,{id:"related-documentation",children:"Related Documentation"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"/docs/Features/multi-tenancy",children:"Multi-Tenancy Feature"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"/docs/Features/organisations",children:"Organisations Feature"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"/docs/Features/access-control",children:"Access Control"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"/docs/development/testing",children:"Testing"})}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}}}]);