"use strict";(self.webpackChunkopen_catalogi_docs=self.webpackChunkopen_catalogi_docs||[]).push([[1263],{28453:(e,n,i)=>{i.d(n,{R:()=>a,x:()=>l});var t=i(96540);const r={},s=t.createContext(r);function a(e){const n=t.useContext(s);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),t.createElement(s.Provider,{value:n},e.children)}},98906:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>o,contentTitle:()=>l,default:()=>u,frontMatter:()=>a,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"technical/bulk-operations-implementation","title":"Bulk Operations Implementation","description":"This document describes the technical implementation of the bulk operations feature in OpenRegister, including the architecture, design decisions, and internal workings.","source":"@site/docs/technical/bulk-operations-implementation.md","sourceDirName":"technical","slug":"/technical/bulk-operations-implementation","permalink":"/docs/technical/bulk-operations-implementation","draft":false,"unlisted":false,"editUrl":"https://github.com/conductionnl/openregister/tree/main/website/docs/technical/bulk-operations-implementation.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Array Faceting","permalink":"/docs/technical/array-faceting"},"next":{"title":"Cache Invalidation System","permalink":"/docs/technical/cache-invalidation-system"}}');var r=i(74848),s=i(28453);const a={},l="Bulk Operations Implementation",o={},c=[{value:"Architecture Overview",id:"architecture-overview",level:2},{value:"Component Details",id:"component-details",level:2},{value:"1. BulkController (<code>lib/Controller/BulkController.php</code>)",id:"1-bulkcontroller-libcontrollerbulkcontrollerphp",level:3},{value:"Key Features:",id:"key-features",level:4},{value:"Methods:",id:"methods",level:4},{value:"Security:",id:"security",level:4},{value:"2. ObjectService (<code>lib/Service/ObjectService.php</code>)",id:"2-objectservice-libserviceobjectservicephp",level:3},{value:"Key Features:",id:"key-features-1",level:4},{value:"Methods:",id:"methods-1",level:4},{value:"Permission Filtering:",id:"permission-filtering",level:4},{value:"3. ObjectEntityMapper (<code>lib/Db/ObjectEntityMapper.php</code>)",id:"3-objectentitymapper-libdbobjectentitymapperphp",level:3},{value:"Key Features:",id:"key-features-2",level:4},{value:"Methods:",id:"methods-2",level:4},{value:"Private Helper Methods:",id:"private-helper-methods",level:4},{value:"Database Operations",id:"database-operations",level:2},{value:"Bulk Delete Implementation",id:"bulk-delete-implementation",level:3},{value:"Bulk Publish/Depublish Implementation",id:"bulk-publishdepublish-implementation",level:3},{value:"Data Type Handling",id:"data-type-handling",level:3},{value:"Performance Optimizations",id:"performance-optimizations",level:2},{value:"1. Batch Processing",id:"1-batch-processing",level:3},{value:"2. Efficient SQL Queries",id:"2-efficient-sql-queries",level:3},{value:"3. Transaction Management",id:"3-transaction-management",level:3},{value:"4. Dynamic Packet Size Management",id:"4-dynamic-packet-size-management",level:3},{value:"Automatic Detection",id:"automatic-detection",level:4},{value:"Configurable Buffer Percentage",id:"configurable-buffer-percentage",level:4},{value:"Adaptive Buffer Sizing",id:"adaptive-buffer-sizing",level:4},{value:"Dynamic Chunk Sizing",id:"dynamic-chunk-sizing",level:4},{value:"Configuration Options",id:"configuration-options",level:2},{value:"1. Max Packet Size Buffer Configuration",id:"1-max-packet-size-buffer-configuration",level:3},{value:"Runtime Configuration",id:"runtime-configuration",level:4},{value:"Configuration in Service Layer",id:"configuration-in-service-layer",level:4},{value:"Environment-Based Configuration",id:"environment-based-configuration",level:4},{value:"2. Large Object Threshold Configuration",id:"2-large-object-threshold-configuration",level:3},{value:"3. Chunk Size Bounds",id:"3-chunk-size-bounds",level:3},{value:"Error Handling Strategy",id:"error-handling-strategy",level:2},{value:"1. Input Validation",id:"1-input-validation",level:3},{value:"2. Database Error Handling",id:"2-database-error-handling",level:3},{value:"3. Partial Success Handling",id:"3-partial-success-handling",level:3},{value:"Troubleshooting Common Issues",id:"troubleshooting-common-issues",level:2},{value:"1. Max Packet Size Errors",id:"1-max-packet-size-errors",level:3},{value:"Check Current Database Setting",id:"check-current-database-setting",level:4},{value:"Adjust Buffer Percentage",id:"adjust-buffer-percentage",level:4},{value:"Monitor Chunk Sizing",id:"monitor-chunk-sizing",level:4},{value:"2. Large Object Handling",id:"2-large-object-handling",level:3},{value:"3. Performance Monitoring",id:"3-performance-monitoring",level:3},{value:"Security Considerations",id:"security-considerations",level:2},{value:"1. Admin-Only Access",id:"1-admin-only-access",level:3},{value:"2. RBAC Integration",id:"2-rbac-integration",level:3},{value:"3. Multi-Organization Support",id:"3-multi-organization-support",level:3},{value:"Logging and Monitoring",id:"logging-and-monitoring",level:2},{value:"1. Operation Logging",id:"1-operation-logging",level:3},{value:"2. Performance Monitoring",id:"2-performance-monitoring",level:3},{value:"Testing Strategy",id:"testing-strategy",level:2},{value:"1. Unit Tests",id:"1-unit-tests",level:3},{value:"2. Integration Tests",id:"2-integration-tests",level:3},{value:"3. Performance Tests",id:"3-performance-tests",level:3},{value:"Future Enhancements",id:"future-enhancements",level:2},{value:"1. Async Processing",id:"1-async-processing",level:3},{value:"2. Progress Tracking",id:"2-progress-tracking",level:3},{value:"3. Batch Size Optimization",id:"3-batch-size-optimization",level:3},{value:"Conclusion",id:"conclusion",level:2}];function d(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"bulk-operations-implementation",children:"Bulk Operations Implementation"})}),"\n",(0,r.jsx)(n.p,{children:"This document describes the technical implementation of the bulk operations feature in OpenRegister, including the architecture, design decisions, and internal workings."}),"\n",(0,r.jsx)(n.h2,{id:"architecture-overview",children:"Architecture Overview"}),"\n",(0,r.jsx)(n.p,{children:"The bulk operations feature follows a layered architecture pattern:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                    API Layer (BulkController)               \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                  Service Layer (ObjectService)              \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                Data Layer (ObjectEntityMapper)              \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                    Database Layer (MySQL)                   \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,r.jsx)(n.h2,{id:"component-details",children:"Component Details"}),"\n",(0,r.jsxs)(n.h3,{id:"1-bulkcontroller-libcontrollerbulkcontrollerphp",children:["1. BulkController (",(0,r.jsx)(n.code,{children:"lib/Controller/BulkController.php"}),")"]}),"\n",(0,r.jsx)(n.p,{children:"The controller handles HTTP requests and provides the API interface for bulk operations."}),"\n",(0,r.jsx)(n.h4,{id:"key-features",children:"Key Features:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Admin-only access"}),": All endpoints require admin privileges"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Input validation"}),": Validates request parameters and data formats"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Error handling"}),": Provides consistent error responses"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"CSRF bypass"}),": Uses ",(0,r.jsx)(n.code,{children:"@NoCSRFRequired"})," annotation for API access"]}),"\n"]}),"\n",(0,r.jsx)(n.h4,{id:"methods",children:"Methods:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"delete()"})," - Bulk delete operations"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"publish()"})," - Bulk publish operations"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"depublish()"})," - Bulk depublish operations"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"save()"})," - Bulk save operations"]}),"\n"]}),"\n",(0,r.jsx)(n.h4,{id:"security",children:"Security:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"private function isCurrentUserAdmin(): bool\n{\n    $user = $this->userSession->getUser();\n    if ($user === null) {\n        return false;\n    }\n    return $this->groupManager->isAdmin($user->getUID());\n}\n"})}),"\n",(0,r.jsxs)(n.h3,{id:"2-objectservice-libserviceobjectservicephp",children:["2. ObjectService (",(0,r.jsx)(n.code,{children:"lib/Service/ObjectService.php"}),")"]}),"\n",(0,r.jsx)(n.p,{children:"The service layer provides business logic and coordinates between the controller and data layer."}),"\n",(0,r.jsx)(n.h4,{id:"key-features-1",children:"Key Features:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Permission filtering"}),": Applies RBAC and multi-organization filtering"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Transaction management"}),": Ensures data consistency"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Error handling"}),": Provides detailed error information"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Logging"}),": Comprehensive operation logging"]}),"\n"]}),"\n",(0,r.jsx)(n.h4,{id:"methods-1",children:"Methods:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"deleteObjects()"})," - Orchestrates bulk delete operations"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"publishObjects()"})," - Orchestrates bulk publish operations"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"depublishObjects()"})," - Orchestrates bulk depublish operations"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"saveObjects()"})," - Orchestrates bulk save operations"]}),"\n"]}),"\n",(0,r.jsx)(n.h4,{id:"permission-filtering",children:"Permission Filtering:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"private function filterUuidsForPermissions(array $uuids, bool $rbac, bool $multi): array\n{\n    // Get objects for permission checking\n    $objects = $this->objectEntityMapper->findAll(ids: $uuids, includeDeleted: true);\n    \n    foreach ($objects as $object) {\n        // Check RBAC permissions\n        if ($rbac && $userId !== null) {\n            // Verify user has permission for this object\n        }\n        \n        // Check multi-organization permissions\n        if ($multi && $activeOrganisation !== null) {\n            // Verify object belongs to active organization\n        }\n    }\n}\n"})}),"\n",(0,r.jsxs)(n.h3,{id:"3-objectentitymapper-libdbobjectentitymapperphp",children:["3. ObjectEntityMapper (",(0,r.jsx)(n.code,{children:"lib/Db/ObjectEntityMapper.php"}),")"]}),"\n",(0,r.jsx)(n.p,{children:"The data layer handles database operations and provides optimized bulk operations."}),"\n",(0,r.jsx)(n.h4,{id:"key-features-2",children:"Key Features:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Transaction support"}),": All operations wrapped in database transactions"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Optimized queries"}),": Uses efficient SQL for bulk operations"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Data type handling"}),": Properly handles DateTime, boolean, and JSON data"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Error recovery"}),": Graceful handling of database errors"]}),"\n"]}),"\n",(0,r.jsx)(n.h4,{id:"methods-2",children:"Methods:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"deleteObjects()"})," - Public interface for bulk delete"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"publishObjects()"})," - Public interface for bulk publish"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"depublishObjects()"})," - Public interface for bulk depublish"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"saveObjects()"})," - Public interface for bulk save"]}),"\n"]}),"\n",(0,r.jsx)(n.h4,{id:"private-helper-methods",children:"Private Helper Methods:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"bulkDelete()"})," - Internal bulk delete implementation"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"bulkPublish()"})," - Internal bulk publish implementation"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"bulkDepublish()"})," - Internal bulk depublish implementation"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"bulkUpdate()"})," - Internal bulk update implementation"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"bulkInsert()"})," - Internal bulk insert implementation"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"database-operations",children:"Database Operations"}),"\n",(0,r.jsx)(n.h3,{id:"bulk-delete-implementation",children:"Bulk Delete Implementation"}),"\n",(0,r.jsx)(n.p,{children:"The bulk delete operation handles both soft and hard deletes:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"private function bulkDelete(array $uuids): array\n{\n    // 1. Get current state of objects\n    $objects = $this->getObjectsForDeletion($uuids);\n    \n    // 2. Separate objects for soft vs hard delete\n    $softDeleteIds = [];\n    $hardDeleteIds = [];\n    \n    foreach ($objects as $object) {\n        if (empty($object['deleted'])) {\n            $softDeleteIds[] = $object['id']; // Soft delete\n        } else {\n            $hardDeleteIds[] = $object['id']; // Hard delete\n        }\n    }\n    \n    // 3. Perform soft deletes (UPDATE with deleted timestamp)\n    if (!empty($softDeleteIds)) {\n        $this->performSoftDeletes($softDeleteIds);\n    }\n    \n    // 4. Perform hard deletes (DELETE from database)\n    if (!empty($hardDeleteIds)) {\n        $this->performHardDeletes($hardDeleteIds);\n    }\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"bulk-publishdepublish-implementation",children:"Bulk Publish/Depublish Implementation"}),"\n",(0,r.jsx)(n.p,{children:"Both publish and depublish operations follow the same pattern:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"private function bulkPublish(array $uuids, \\DateTime|bool $datetime = true): array\n{\n    // 1. Determine datetime value\n    $publishedValue = $this->determineDatetimeValue($datetime);\n    \n    // 2. Get object IDs for the UUIDs\n    $objectIds = $this->getObjectIdsForUuids($uuids);\n    \n    // 3. Update published timestamp\n    if (!empty($objectIds)) {\n        $this->updatePublishedTimestamp($objectIds, $publishedValue);\n    }\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"data-type-handling",children:"Data Type Handling"}),"\n",(0,r.jsx)(n.p,{children:"The implementation properly handles various data types:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"private function getEntityValue(ObjectEntity $entity, string $column): mixed\n{\n    $value = $this->getPropertyValue($entity, $column);\n    \n    // Handle DateTime objects\n    if ($value instanceof \\DateTime) {\n        $value = $value->format('Y-m-d H:i:s');\n    }\n    \n    // Handle boolean values\n    if (is_bool($value)) {\n        $value = $value ? 1 : 0;\n    }\n    \n    // Handle JSON encoding for arrays\n    if (is_array($value) && in_array($column, ['files', 'relations', 'locked'])) {\n        $value = json_encode($value);\n    }\n    \n    return $value;\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"performance-optimizations",children:"Performance Optimizations"}),"\n",(0,r.jsx)(n.h3,{id:"1-batch-processing",children:"1. Batch Processing"}),"\n",(0,r.jsx)(n.p,{children:"Large operations are processed in batches to avoid memory issues:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"// Process 1000 objects at a time\n$batchSize = 1000;\nfor ($i = 0; $i < count($insertObjects); $i += $batchSize) {\n    $batch = array_slice($insertObjects, $i, $batchSize);\n    $this->processBatch($batch);\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"2-efficient-sql-queries",children:"2. Efficient SQL Queries"}),"\n",(0,r.jsx)(n.p,{children:"Uses optimized SQL for bulk operations:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"-- Bulk UPDATE with IN clause\nUPDATE oc_openregister_objects \nSET published = ? \nWHERE id IN (?, ?, ?)\n\n-- Bulk DELETE with IN clause  \nDELETE FROM oc_openregister_objects \nWHERE id IN (?, ?, ?)\n"})}),"\n",(0,r.jsx)(n.h3,{id:"3-transaction-management",children:"3. Transaction Management"}),"\n",(0,r.jsx)(n.p,{children:"All operations are wrapped in database transactions:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"try {\n    $this->db->beginTransaction();\n    \n    // Perform bulk operations\n    $result = $this->performBulkOperation($data);\n    \n    $this->db->commit();\n    return $result;\n} catch (\\Exception $e) {\n    $this->db->rollBack();\n    throw $e;\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"4-dynamic-packet-size-management",children:"4. Dynamic Packet Size Management"}),"\n",(0,r.jsxs)(n.p,{children:["The system automatically detects and adapts to the database's ",(0,r.jsx)(n.code,{children:"max_allowed_packet"})," setting to prevent packet size errors during large bulk operations:"]}),"\n",(0,r.jsx)(n.h4,{id:"automatic-detection",children:"Automatic Detection"}),"\n",(0,r.jsxs)(n.p,{children:["The system queries the database to determine the actual ",(0,r.jsx)(n.code,{children:"max_allowed_packet"})," value:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function getMaxAllowedPacketSize(): int\n{\n    try {\n        $stmt = $this->db->executeQuery('SHOW VARIABLES LIKE \\'max_allowed_packet\\'');\n        $result = $stmt->fetch();\n        \n        if ($result && isset($result['Value'])) {\n            return (int) $result['Value'];\n        }\n    } catch (\\Exception $e) {\n        $this->logger->warning('Could not get max_allowed_packet, using default', [\n            'defaultSize' => 16777216,\n            'unit' => 'bytes'\n        ]);\n    }\n    \n    // Default fallback value (16MB)\n    return 16777216;\n}\n"})}),"\n",(0,r.jsx)(n.h4,{id:"configurable-buffer-percentage",children:"Configurable Buffer Percentage"}),"\n",(0,r.jsx)(n.p,{children:"Administrators can adjust the safety buffer percentage used for chunk size calculations:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"// Set buffer to 30% (more conservative)\n$objectEntityMapper->setMaxPacketSizeBuffer(0.3);\n\n// Set buffer to 60% (less conservative)\n$objectEntityMapper->setMaxPacketSizeBuffer(0.6);\n\n// Get current buffer setting\n$currentBuffer = $objectEntityMapper->getMaxPacketSizeBuffer();\n"})}),"\n",(0,r.jsx)(n.h4,{id:"adaptive-buffer-sizing",children:"Adaptive Buffer Sizing"}),"\n",(0,r.jsx)(n.p,{children:"The system automatically adjusts the buffer based on the detected packet size:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"\u2264 16MB"}),": 30% buffer (very conservative)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"> 16MB"}),": 40% buffer (conservative)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"> 32MB"}),": 50% buffer (moderate)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"> 64MB"}),": 60% buffer (less conservative)"]}),"\n"]}),"\n",(0,r.jsx)(n.h4,{id:"dynamic-chunk-sizing",children:"Dynamic Chunk Sizing"}),"\n",(0,r.jsx)(n.p,{children:"Chunk sizes are calculated dynamically based on actual object sizes and the configured buffer:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"private function calculateOptimalChunkSize(array $insertObjects, array $updateObjects): int\n{\n    // Sample objects to estimate data size\n    $sampleSize = min(20, max(5, count($insertObjects) + count($updateObjects)));\n    \n    // Calculate safety object size (using maximum size for safety)\n    $safetyObjectSize = max($averageObjectSize, $maxObjectSize);\n    \n    // Use dynamic buffer percentage\n    $maxPacketSize = $this->getMaxAllowedPacketSize() * $this->maxPacketSizeBuffer;\n    $safeChunkSize = intval($maxPacketSize / $safetyObjectSize);\n    \n    // Ensure chunk size is within conservative bounds\n    return max(5, min(100, $safeChunkSize));\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"configuration-options",children:"Configuration Options"}),"\n",(0,r.jsx)(n.h3,{id:"1-max-packet-size-buffer-configuration",children:"1. Max Packet Size Buffer Configuration"}),"\n",(0,r.jsx)(n.p,{children:"The system provides several configuration methods for fine-tuning bulk operation performance:"}),"\n",(0,r.jsx)(n.h4,{id:"runtime-configuration",children:"Runtime Configuration"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"// Get the ObjectEntityMapper instance\n$objectEntityMapper = $this->getObjectEntityMapper();\n\n// Configure buffer percentage (0.1 = 10%, 0.5 = 50%)\n$objectEntityMapper->setMaxPacketSizeBuffer(0.3);  // Very conservative\n$objectEntityMapper->setMaxPacketSizeBuffer(0.5);  // Default\n$objectEntityMapper->setMaxPacketSizeBuffer(0.7);  // Less conservative\n\n// Get current configuration\n$currentBuffer = $objectEntityMapper->getMaxPacketSizeBuffer();\n$maxPacketSize = $objectEntityMapper->getMaxAllowedPacketSize();\n"})}),"\n",(0,r.jsx)(n.h4,{id:"configuration-in-service-layer",children:"Configuration in Service Layer"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"// In ObjectService or similar service class\npublic function configureBulkOperations(float $bufferPercentage): void\n{\n    if ($bufferPercentage >= 0.1 && $bufferPercentage <= 0.9) {\n        $this->objectEntityMapper->setMaxPacketSizeBuffer($bufferPercentage);\n        $this->logger->info('Bulk operations buffer set to ' . ($bufferPercentage * 100) . '%');\n    }\n}\n"})}),"\n",(0,r.jsx)(n.h4,{id:"environment-based-configuration",children:"Environment-Based Configuration"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"// Configure based on environment variables\n$bufferPercentage = getenv('OPENREGISTER_BULK_BUFFER') ?: 0.5;\n$objectEntityMapper->setMaxPacketSizeBuffer((float) $bufferPercentage);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"2-large-object-threshold-configuration",children:"2. Large Object Threshold Configuration"}),"\n",(0,r.jsx)(n.p,{children:"The threshold for separating large objects can be configured:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"// Default threshold is 500KB (500,000 bytes)\n$maxSafeSize = 1000000; // 1MB threshold\n\n$objectGroups = $this->separateLargeObjects($objects, $maxSafeSize);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"3-chunk-size-bounds",children:"3. Chunk Size Bounds"}),"\n",(0,r.jsx)(n.p,{children:"The system enforces conservative bounds for chunk sizes:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"// Minimum chunk size: 5 objects\n// Maximum chunk size: 100 objects\n// These bounds prevent memory issues and ensure stability\n\n$optimalChunkSize = max(5, min(100, $safeChunkSize));\n"})}),"\n",(0,r.jsx)(n.h2,{id:"error-handling-strategy",children:"Error Handling Strategy"}),"\n",(0,r.jsx)(n.h3,{id:"1-input-validation",children:"1. Input Validation"}),"\n",(0,r.jsx)(n.p,{children:"Comprehensive validation of input parameters:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"// Validate UUIDs array\nif (empty($uuids) || !is_array($uuids)) {\n    return new JSONResponse(\n        ['error' => 'Invalid input. \"uuids\" array is required.'],\n        Http::STATUS_BAD_REQUEST\n    );\n}\n\n// Validate datetime format\nif ($datetime !== true && $datetime !== false && $datetime !== null) {\n    try {\n        $datetime = new \\DateTime($datetime);\n    } catch (Exception $e) {\n        return new JSONResponse(\n            ['error' => 'Invalid datetime format. Use ISO 8601 format.'],\n            Http::STATUS_BAD_REQUEST\n        );\n    }\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"2-database-error-handling",children:"2. Database Error Handling"}),"\n",(0,r.jsx)(n.p,{children:"Graceful handling of database errors:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:'try {\n    $qb->executeStatement();\n} catch (\\Exception $e) {\n    throw new \\Exception("Database operation failed: " . $e->getMessage());\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"3-partial-success-handling",children:"3. Partial Success Handling"}),"\n",(0,r.jsx)(n.p,{children:"Operations continue even if some objects fail:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"$processedCount = 0;\n$skippedCount = 0;\n\nforeach ($objects as $object) {\n    try {\n        $this->processObject($object);\n        $processedCount++;\n    } catch (\\Exception $e) {\n        $skippedCount++;\n        // Object processing failed, continue with next object\n    }\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"troubleshooting-common-issues",children:"Troubleshooting Common Issues"}),"\n",(0,r.jsx)(n.h3,{id:"1-max-packet-size-errors",children:"1. Max Packet Size Errors"}),"\n",(0,r.jsxs)(n.p,{children:["If you encounter ",(0,r.jsx)(n.code,{children:"SQLSTATE[08S01]: Communication link failure: 1153 Got a packet bigger than 'max_allowed_packet' bytes"})," errors:"]}),"\n",(0,r.jsx)(n.h4,{id:"check-current-database-setting",children:"Check Current Database Setting"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'# From within the Nextcloud container\ndocker exec -it -u 33 master-nextcloud-1 bash -c "mysql -u root -p -e \'SHOW VARIABLES LIKE \\"max_allowed_packet\\";\'"\n\n# Or directly from MySQL container\ndocker exec -it master-database-mysql-1 mysql -u root -p -e \'SHOW VARIABLES LIKE "max_allowed_packet";\'\n'})}),"\n",(0,r.jsx)(n.h4,{id:"adjust-buffer-percentage",children:"Adjust Buffer Percentage"}),"\n",(0,r.jsx)(n.p,{children:"If the system is still too aggressive, reduce the buffer percentage:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"// More conservative (smaller chunks)\n$objectEntityMapper->setMaxPacketSizeBuffer(0.3);\n\n// Very conservative (very small chunks)\n$objectEntityMapper->setMaxPacketSizeBuffer(0.2);\n"})}),"\n",(0,r.jsx)(n.h4,{id:"monitor-chunk-sizing",children:"Monitor Chunk Sizing"}),"\n",(0,r.jsx)(n.p,{children:"Check the application logs for chunk size calculations:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"docker logs master-nextcloud-1 | grep 'ObjectEntityMapper.*chunk size'\ndocker logs master-nextcloud-1 | grep 'ObjectEntityMapper.*Max packet size buffer'\n"})}),"\n",(0,r.jsx)(n.h3,{id:"2-large-object-handling",children:"2. Large Object Handling"}),"\n",(0,r.jsx)(n.p,{children:"The system automatically separates extremely large objects (>500KB by default) for individual processing:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"// Objects larger than this threshold are processed individually\n$maxSafeSize = 500000; // 500KB\n\n$objectGroups = $this->separateLargeObjects($objects, $maxSafeSize);\n$largeObjects = $objectGroups['large'];      // Process individually\n$normalObjects = $objectGroups['normal'];    // Process in chunks\n"})}),"\n",(0,r.jsx)(n.h3,{id:"3-performance-monitoring",children:"3. Performance Monitoring"}),"\n",(0,r.jsx)(n.p,{children:"Monitor bulk operation performance through logs:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# Check for performance issues\ndocker logs master-nextcloud-1 | grep 'ObjectEntityMapper.*Starting saveObjects'\ndocker logs master-nextcloud-1 | grep 'ObjectEntityMapper.*Completed processing'\n\n# Monitor memory usage\ndocker logs master-nextcloud-1 | grep 'ObjectEntityMapper.*memory'\n"})}),"\n",(0,r.jsx)(n.h2,{id:"security-considerations",children:"Security Considerations"}),"\n",(0,r.jsx)(n.h3,{id:"1-admin-only-access",children:"1. Admin-Only Access"}),"\n",(0,r.jsx)(n.p,{children:"All bulk operations require admin privileges:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"if (!$this->isCurrentUserAdmin()) {\n    return new JSONResponse(\n        ['error' => 'Insufficient permissions. Admin access required.'],\n        Http::STATUS_FORBIDDEN\n    );\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"2-rbac-integration",children:"2. RBAC Integration"}),"\n",(0,r.jsx)(n.p,{children:"Objects are filtered based on user permissions:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"if ($rbac && $userId !== null) {\n    $schema = $this->schemaMapper->find($objectSchema);\n    if (!$this->hasPermission($schema, 'delete', $userId, $objectOwner, $rbac)) {\n        continue; // Skip this object - no permission\n    }\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"3-multi-organization-support",children:"3. Multi-Organization Support"}),"\n",(0,r.jsx)(n.p,{children:"Objects are filtered based on organization context:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"if ($multi && $activeOrganisation !== null) {\n    $objectOrganisation = $object->getOrganisation();\n    if ($objectOrganisation !== null && $objectOrganisation !== $activeOrganisation) {\n        continue; // Skip this object - different organization\n    }\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"logging-and-monitoring",children:"Logging and Monitoring"}),"\n",(0,r.jsx)(n.h3,{id:"1-operation-logging",children:"1. Operation Logging"}),"\n",(0,r.jsx)(n.p,{children:"All operations are logged with detailed information:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"// Transaction logging has been removed for production\n// Operations are tracked through audit trails instead\n"})}),"\n",(0,r.jsx)(n.h3,{id:"2-performance-monitoring",children:"2. Performance Monitoring"}),"\n",(0,r.jsx)(n.p,{children:"Execution time and resource usage are tracked:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"$startTime = microtime(true);\n$startMemory = memory_get_usage();\n\n// Perform operation\n\n$endTime = microtime(true);\n$endMemory = memory_get_usage();\n\n// Performance metrics can be logged to application logs if needed\n// $operationTime = ($endTime - $startTime);\n// $memoryUsed = ($endMemory - $startMemory);\n"})}),"\n",(0,r.jsx)(n.h2,{id:"testing-strategy",children:"Testing Strategy"}),"\n",(0,r.jsx)(n.h3,{id:"1-unit-tests",children:"1. Unit Tests"}),"\n",(0,r.jsx)(n.p,{children:"Individual components are tested in isolation:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function testBulkDeleteWithValidUuids(): void\n{\n    $uuids = ['uuid1', 'uuid2', 'uuid3'];\n    $result = $this->objectService->deleteObjects($uuids);\n    \n    $this->assertCount(3, $result);\n    $this->assertContains('uuid1', $result);\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"2-integration-tests",children:"2. Integration Tests"}),"\n",(0,r.jsx)(n.p,{children:"End-to-end testing of the complete workflow:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function testBulkDeleteEndpoint(): void\n{\n    $response = $this->client->post('/api/bulk/test/test/delete', [\n        'json' => ['uuids' => ['uuid1', 'uuid2']]\n    ]);\n    \n    $this->assertEquals(200, $response->getStatusCode());\n    $this->assertTrue($response->json()['success']);\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"3-performance-tests",children:"3. Performance Tests"}),"\n",(0,r.jsx)(n.p,{children:"Load testing for large datasets:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function testBulkDeletePerformance(): void\n{\n    $uuids = $this->generateTestUuids(1000);\n    \n    $startTime = microtime(true);\n    $result = $this->objectService->deleteObjects($uuids);\n    $endTime = microtime(true);\n    \n    $this->assertLessThan(5.0, $endTime - $startTime); // Should complete within 5 seconds\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"future-enhancements",children:"Future Enhancements"}),"\n",(0,r.jsx)(n.h3,{id:"1-async-processing",children:"1. Async Processing"}),"\n",(0,r.jsx)(n.p,{children:"For very large operations, consider implementing async processing:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function deleteObjectsAsync(array $uuids): PromiseInterface\n{\n    return React\\Async\\async(function () use ($uuids) {\n        return $this->deleteObjects($uuids);\n    });\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"2-progress-tracking",children:"2. Progress Tracking"}),"\n",(0,r.jsx)(n.p,{children:"Add progress tracking for long-running operations:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function deleteObjectsWithProgress(array $uuids, callable $progressCallback): array\n{\n    $total = count($uuids);\n    $processed = 0;\n    \n    foreach ($uuids as $uuid) {\n        $this->deleteObject($uuid);\n        $processed++;\n        $progressCallback($processed, $total);\n    }\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"3-batch-size-optimization",children:"3. Batch Size Optimization"}),"\n",(0,r.jsx)(n.p,{children:"Dynamic batch size based on object size and system resources:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"private function calculateOptimalBatchSize(array $objects): int\n{\n    $totalSize = array_sum(array_map('strlen', json_encode($objects)));\n    $memoryLimit = ini_get('memory_limit');\n    \n    return min(1000, floor($memoryLimit * 0.1 / $totalSize));\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"conclusion",children:"Conclusion"}),"\n",(0,r.jsx)(n.p,{children:"The bulk operations implementation provides a robust, secure, and performant solution for managing large datasets in OpenRegister. The layered architecture ensures maintainability, while the comprehensive error handling and logging provide observability and debugging capabilities."}),"\n",(0,r.jsx)(n.p,{children:"The implementation follows Nextcloud best practices and integrates seamlessly with the existing RBAC and multi-organization systems, ensuring that security and access control are maintained even for bulk operations."})]})}function u(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}}}]);