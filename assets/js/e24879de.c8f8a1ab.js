"use strict";(self.webpackChunkopen_catalogi_docs=self.webpackChunkopen_catalogi_docs||[]).push([[5095],{23904:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>d,contentTitle:()=>a,default:()=>h,frontMatter:()=>l,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"fixes/FACET_PERFORMANCE_ANALYSIS","title":"Facet Performance Analysis & Optimization Plan","description":"\ud83d\udd0d Performance Issues Identified","source":"@site/docs/fixes/FACET_PERFORMANCE_ANALYSIS.md","sourceDirName":"fixes","slug":"/fixes/FACET_PERFORMANCE_ANALYSIS","permalink":"/docs/fixes/FACET_PERFORMANCE_ANALYSIS","draft":false,"unlisted":false,"editUrl":"https://github.com/conductionnl/openregister/tree/main/website/docs/fixes/FACET_PERFORMANCE_ANALYSIS.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Facet System Implementation Guide","permalink":"/docs/fixes/FACET_IMPLEMENTATION"},"next":{"title":"InversedBy Relaties Fixes - Samenvatting","permalink":"/docs/fixes/INVERSEDBY_FIXES_SUMMARY"}}');var t=s(74848),r=s(28453);const l={},a="Facet Performance Analysis & Optimization Plan",d={},c=[{value:"\ud83d\udd0d Performance Issues Identified",id:"-performance-issues-identified",level:2},{value:"1. <strong>Missing Database Indexes (Critical)</strong>",id:"1-missing-database-indexes-critical",level:3},{value:"2. <strong>JSON Field Performance (Major)</strong>",id:"2-json-field-performance-major",level:3},{value:"3. <strong>Sequential Query Execution (Major)</strong>",id:"3-sequential-query-execution-major",level:3},{value:"\ud83d\ude80 Optimization Solutions",id:"-optimization-solutions",level:2},{value:"Phase 1: Immediate Indexes (Run Migration)",id:"phase-1-immediate-indexes-run-migration",level:3},{value:"Phase 2: Query Optimization (Code Changes)",id:"phase-2-query-optimization-code-changes",level:3},{value:"Phase 3: Advanced Optimizations (Future)",id:"phase-3-advanced-optimizations-future",level:3},{value:"\ud83d\udcca Performance Targets",id:"-performance-targets",level:2},{value:"\ud83d\udee0\ufe0f Implementation Steps",id:"\ufe0f-implementation-steps",level:2},{value:"Step 1: Apply Database Indexes (Immediate)",id:"step-1-apply-database-indexes-immediate",level:3},{value:"Step 2: Test Performance Improvement",id:"step-2-test-performance-improvement",level:3},{value:"Step 3: Code Integration (Next Phase)",id:"step-3-code-integration-next-phase",level:3},{value:"\u26a1 Quick Wins Available Now",id:"-quick-wins-available-now",level:2},{value:"Option 1: Reduce Facet Scope",id:"option-1-reduce-facet-scope",level:3},{value:"Option 2: Remove Field Discovery",id:"option-2-remove-field-discovery",level:3},{value:"Option 3: Limit Results",id:"option-3-limit-results",level:3},{value:"\ud83c\udfaf Expected Results",id:"-expected-results",level:2}];function o(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"facet-performance-analysis--optimization-plan",children:"Facet Performance Analysis & Optimization Plan"})}),"\n",(0,t.jsx)(n.h2,{id:"-performance-issues-identified",children:"\ud83d\udd0d Performance Issues Identified"}),"\n",(0,t.jsxs)(n.p,{children:["Your faceting system currently takes ",(0,t.jsx)(n.strong,{children:"7+ seconds"})," to respond. Here's why:"]}),"\n",(0,t.jsxs)(n.h3,{id:"1-missing-database-indexes-critical",children:["1. ",(0,t.jsx)(n.strong,{children:"Missing Database Indexes (Critical)"})]}),"\n",(0,t.jsxs)(n.p,{children:["Current ",(0,t.jsx)(n.code,{children:"openregister_objects"})," table only has:"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Primary key on ",(0,t.jsx)(n.code,{children:"id"})]}),"\n",(0,t.jsxs)(n.li,{children:["Index on ",(0,t.jsx)(n.code,{children:"uuid"}),", ",(0,t.jsx)(n.code,{children:"register"}),", ",(0,t.jsx)(n.code,{children:"schema"}),", and a composite ",(0,t.jsx)(n.code,{children:"slug+register+schema"})]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Missing crucial indexes:"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\u274c No index on ",(0,t.jsx)(n.code,{children:"deleted"})," (used in EVERY query)"]}),"\n",(0,t.jsxs)(n.li,{children:["\u274c No index on ",(0,t.jsx)(n.code,{children:"published"})," (used for lifecycle filtering)"]}),"\n",(0,t.jsxs)(n.li,{children:["\u274c No index on ",(0,t.jsx)(n.code,{children:"created"}),", ",(0,t.jsx)(n.code,{children:"updated"})," (common facet fields)"]}),"\n",(0,t.jsxs)(n.li,{children:["\u274c No index on ",(0,t.jsx)(n.code,{children:"organisation"}),", ",(0,t.jsx)(n.code,{children:"owner"})," (common facet fields)"]}),"\n",(0,t.jsx)(n.li,{children:"\u274c No composite indexes for filter combinations"}),"\n"]}),"\n",(0,t.jsxs)(n.h3,{id:"2-json-field-performance-major",children:["2. ",(0,t.jsx)(n.strong,{children:"JSON Field Performance (Major)"})]}),"\n",(0,t.jsx)(n.p,{children:"Your JSON facet queries look like:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sql",children:"SELECT JSON_UNQUOTE(JSON_EXTRACT(object, '$.cloudDienstverleningsmodel')), COUNT(*)\nFROM openregister_objects \nWHERE JSON_EXTRACT(object, '$.cloudDienstverleningsmodel') IS NOT NULL\nGROUP BY JSON_UNQUOTE(JSON_EXTRACT(object, '$.cloudDienstverleningsmodel'))\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Problems:"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"\u274c Full table scan of 82,970+ rows per JSON facet"}),"\n",(0,t.jsx)(n.li,{children:"\u274c No indexes can optimize JSON_EXTRACT operations"}),"\n",(0,t.jsx)(n.li,{children:"\u274c 12 separate queries = 12 full table scans"}),"\n"]}),"\n",(0,t.jsxs)(n.h3,{id:"3-sequential-query-execution-major",children:["3. ",(0,t.jsx)(n.strong,{children:"Sequential Query Execution (Major)"})]}),"\n",(0,t.jsx)(n.p,{children:"Each of your 12 facets runs a separate database query:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Register facet: 1 query"}),"\n",(0,t.jsx)(n.li,{children:"Schema facet: 1 query"}),"\n",(0,t.jsx)(n.li,{children:"Organisation facet: 1 query"}),"\n",(0,t.jsx)(n.li,{children:"cloudDienstverleningsmodel: 1 query"}),"\n",(0,t.jsx)(n.li,{children:"etc..."}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Total: 12+ separate database queries, many doing full table scans"})}),"\n",(0,t.jsx)(n.h2,{id:"-optimization-solutions",children:"\ud83d\ude80 Optimization Solutions"}),"\n",(0,t.jsx)(n.h3,{id:"phase-1-immediate-indexes-run-migration",children:"Phase 1: Immediate Indexes (Run Migration)"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# Apply the new migration to add critical indexes\ndocker exec -u 33 master-nextcloud-1 php /var/www/html/occ migrations:execute openregister 20250828120000\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Expected improvement: 7 seconds \u2192 2-3 seconds"})}),"\n",(0,t.jsx)(n.h3,{id:"phase-2-query-optimization-code-changes",children:"Phase 2: Query Optimization (Code Changes)"}),"\n",(0,t.jsx)(n.p,{children:"Replace current facet handlers with optimized versions:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Metadata Facets"})," (register, schema, organisation): Use indexed columns"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"JSON Field Facets"}),": Skip or limit for large datasets"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Query Batching"}),": Combine multiple facets where possible"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Expected improvement: 2-3 seconds \u2192 0.5-1 second"})}),"\n",(0,t.jsx)(n.h3,{id:"phase-3-advanced-optimizations-future",children:"Phase 3: Advanced Optimizations (Future)"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Virtual Columns"})," for common JSON fields"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Facet Result Caching"})," (Redis/Memcached)"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Async Facet Loading"})," (load critical facets first)"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"-performance-targets",children:"\ud83d\udcca Performance Targets"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Optimization Phase"}),(0,t.jsx)(n.th,{children:"Current"}),(0,t.jsx)(n.th,{children:"Target"}),(0,t.jsx)(n.th,{children:"Improvement"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"Baseline"})}),(0,t.jsx)(n.td,{children:"7+ seconds"}),(0,t.jsx)(n.td,{children:"-"}),(0,t.jsx)(n.td,{children:"-"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"+ Indexes"})}),(0,t.jsx)(n.td,{children:"7 seconds"}),(0,t.jsx)(n.td,{children:"2-3 seconds"}),(0,t.jsx)(n.td,{children:"60-70%"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"+ Query Optimization"})}),(0,t.jsx)(n.td,{children:"2-3 seconds"}),(0,t.jsx)(n.td,{children:"0.5-1 second"}),(0,t.jsx)(n.td,{children:"80-90%"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"+ Caching"})}),(0,t.jsx)(n.td,{children:"0.5-1 second"}),(0,t.jsx)(n.td,{children:"0.1-0.3 seconds"}),(0,t.jsx)(n.td,{children:"95%+"})]})]})]}),"\n",(0,t.jsx)(n.h2,{id:"\ufe0f-implementation-steps",children:"\ud83d\udee0\ufe0f Implementation Steps"}),"\n",(0,t.jsx)(n.h3,{id:"step-1-apply-database-indexes-immediate",children:"Step 1: Apply Database Indexes (Immediate)"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# Run the migration\ndocker exec -u 33 master-nextcloud-1 php /var/www/html/occ migrations:execute openregister 20250828120000\n"})}),"\n",(0,t.jsx)(n.h3,{id:"step-2-test-performance-improvement",children:"Step 2: Test Performance Improvement"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# Test your original query\ntime curl -u 'admin:admin' 'http://localhost:3000/api/apps/opencatalogi/api/publications?_limit=20&_facetable=true&_facets%5B%40self%5D%5Bregister%5D=terms&_facets%5B%40self%5D%5Bschema%5D=terms&_facets%5B%40self%5D%5Borganisation%5D=terms'\n"})}),"\n",(0,t.jsx)(n.h3,{id:"step-3-code-integration-next-phase",children:"Step 3: Code Integration (Next Phase)"}),"\n",(0,t.jsxs)(n.p,{children:["Integrate the ",(0,t.jsx)(n.code,{children:"OptimizedFacetHandler"})," into your existing system:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-php",children:"// In ObjectEntityMapper.php\nuse OCA\\OpenRegister\\Db\\ObjectHandlers\\OptimizedFacetHandler;\n\npublic function getSimpleFacets(array $query = []): array\n{\n    // Use optimized handler for better performance\n    $optimizedHandler = new OptimizedFacetHandler($this->db);\n    return $optimizedHandler->getBatchedFacets($query['_facets'] ?? [], $query);\n}\n"})}),"\n",(0,t.jsx)(n.h2,{id:"-quick-wins-available-now",children:"\u26a1 Quick Wins Available Now"}),"\n",(0,t.jsx)(n.h3,{id:"option-1-reduce-facet-scope",children:"Option 1: Reduce Facet Scope"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# Instead of 12 facets, test with just critical ones:\n_facets%5B%40self%5D%5Bregister%5D=terms&_facets%5B%40self%5D%5Bschema%5D=terms\n"})}),"\n",(0,t.jsx)(n.h3,{id:"option-2-remove-field-discovery",children:"Option 2: Remove Field Discovery"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# Remove _facetable=true to save ~15ms:\n# OLD: ?_facetable=true&_facets[...]\n# NEW: ?_facets[...]\n"})}),"\n",(0,t.jsx)(n.h3,{id:"option-3-limit-results",children:"Option 3: Limit Results"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# Use _limit=0 for facet-only queries:\n?_limit=0&_facets%5B%40self%5D%5Bregister%5D=terms\n"})}),"\n",(0,t.jsx)(n.h2,{id:"-expected-results",children:"\ud83c\udfaf Expected Results"}),"\n",(0,t.jsx)(n.p,{children:"After applying the database migration:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Register/Schema/Organisation facets"}),": 50-100ms each (from 500ms+)"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"JSON field facets"}),": Still slow but with limits/skipping for large datasets"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Overall response"}),": 2-3 seconds (from 7+ seconds)"]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["The biggest performance gain will come from properly indexing the ",(0,t.jsx)(n.code,{children:"deleted"}),", ",(0,t.jsx)(n.code,{children:"published"}),", and other lifecycle columns that are used in every base query."]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(o,{...e})}):o(e)}},28453:(e,n,s)=>{s.d(n,{R:()=>l,x:()=>a});var i=s(96540);const t={},r=i.createContext(t);function l(e){const n=i.useContext(r);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:l(e.components),i.createElement(r.Provider,{value:n},e.children)}}}]);