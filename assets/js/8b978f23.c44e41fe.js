"use strict";(self.webpackChunkopen_catalogi_docs=self.webpackChunkopen_catalogi_docs||[]).push([[178],{28453:(e,n,i)=>{i.d(n,{R:()=>l,x:()=>c});var s=i(96540);const r={},t=s.createContext(r);function l(e){const n=s.useContext(t);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:l(e.components),s.createElement(t.Provider,{value:n},e.children)}},73481:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>d,contentTitle:()=>c,default:()=>h,frontMatter:()=>l,metadata:()=>s,toc:()=>o});const s=JSON.parse('{"id":"development/services-architecture","title":"Service Architecture","description":"OpenRegister\'s service-oriented architecture with clear separation of concerns","source":"@site/docs/development/services-architecture.md","sourceDirName":"development","slug":"/development/services-architecture","permalink":"/docs/development/services-architecture","draft":false,"unlisted":false,"editUrl":"https://github.com/conductionnl/openregister/tree/main/website/docs/development/services-architecture.md","tags":[],"version":"current","sidebarPosition":1,"frontMatter":{"title":"Service Architecture","sidebar_position":1,"description":"OpenRegister\'s service-oriented architecture with clear separation of concerns","keywords":["Open Register","Architecture","Services","Design Patterns"]},"sidebar":"tutorialSidebar","previous":{"title":"Git Submodules Development Guide","permalink":"/docs/development/git-submodules"},"next":{"title":"Performance Optimization","permalink":"/docs/development/performance-optimization"}}');var r=i(74848),t=i(28453);const l={title:"Service Architecture",sidebar_position:1,description:"OpenRegister's service-oriented architecture with clear separation of concerns",keywords:["Open Register","Architecture","Services","Design Patterns"]},c="OpenRegister Service Architecture",d={},o=[{value:"Overview",id:"overview",level:2},{value:"Core Principles",id:"core-principles",level:2},{value:"Service Hierarchy",id:"service-hierarchy",level:2},{value:"Services Documentation",id:"services-documentation",level:2},{value:"VectorEmbeddingService",id:"vectorembeddingservice",level:3},{value:"ChatService",id:"chatservice",level:3},{value:"SettingsService",id:"settingsservice",level:3},{value:"SettingsController",id:"settingscontroller",level:3},{value:"Service Interactions",id:"service-interactions",level:2},{value:"Testing LLM Embeddings",id:"testing-llm-embeddings",level:3},{value:"Testing LLM Chat",id:"testing-llm-chat",level:3},{value:"Processing Chat with RAG",id:"processing-chat-with-rag",level:3},{value:"Storing Settings",id:"storing-settings",level:3},{value:"Key Architectural Decisions",id:"key-architectural-decisions",level:2},{value:"1. No Temporary Config Storage",id:"1-no-temporary-config-storage",level:3},{value:"2. Service Independence",id:"2-service-independence",level:3},{value:"3. Clear Delegation",id:"3-clear-delegation",level:3},{value:"4. SOLR and LLM Separation",id:"4-solr-and-llm-separation",level:3},{value:"Testing Best Practices",id:"testing-best-practices",level:2},{value:"Testing Service Methods",id:"testing-service-methods",level:3},{value:"Testing Controllers",id:"testing-controllers",level:3},{value:"Summary",id:"summary",level:2},{value:"Service Responsibilities",id:"service-responsibilities",level:3},{value:"Key Takeaways",id:"key-takeaways",level:3}];function a(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"openregister-service-architecture",children:"OpenRegister Service Architecture"})}),"\n",(0,r.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,r.jsxs)(n.p,{children:["OpenRegister follows a ",(0,r.jsx)(n.strong,{children:"service-oriented architecture"})," with clear separation of concerns. This document describes the responsibilities of each service and how they interact."]}),"\n",(0,r.jsx)(n.h2,{id:"core-principles",children:"Core Principles"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Thin Controllers"}),": Controllers validate HTTP requests and delegate to services"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Service Responsibility"}),": Services contain business logic and return structured data"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"No Cross-Dependencies"}),": Services should not depend on each other circularly"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Independent Testing"}),": Each service can test its own functionality"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Clear Boundaries"}),": SOLR, LLM, and data persistence are separate concerns"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"service-hierarchy",children:"Service Hierarchy"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"Controllers (HTTP Layer)\n    \u2193\nServices (Business Logic)\n    \u2193\nMappers/External APIs (Data/Integration Layer)\n"})}),"\n",(0,r.jsx)(n.h2,{id:"services-documentation",children:"Services Documentation"}),"\n",(0,r.jsx)(n.h3,{id:"vectorembeddingservice",children:"VectorEmbeddingService"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Location"}),": ",(0,r.jsx)(n.code,{children:"lib/Service/VectorEmbeddingService.php"})]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Purpose"}),": Handles all vector embedding operations using LLM providers."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Responsibilities"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Generate embeddings for text using multiple LLM providers"}),"\n",(0,r.jsxs)(n.li,{children:["Store embeddings in database (",(0,r.jsx)(n.code,{children:"oc_openregister_vectors"})," table)"]}),"\n",(0,r.jsx)(n.li,{children:"Perform semantic similarity searches using multiple backends"}),"\n",(0,r.jsx)(n.li,{children:"Test embedding configurations without saving settings"}),"\n",(0,r.jsx)(n.li,{children:"Manage embedding generators for different providers"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Provider Support"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["OpenAI: ",(0,r.jsx)(n.code,{children:"text-embedding-ada-002"}),", ",(0,r.jsx)(n.code,{children:"text-embedding-3-small"}),", ",(0,r.jsx)(n.code,{children:"text-embedding-3-large"})]}),"\n",(0,r.jsx)(n.li,{children:"Fireworks AI: Custom OpenAI-compatible API with various models"}),"\n",(0,r.jsx)(n.li,{children:"Ollama: Local models with custom configurations"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Key Methods"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"generateEmbedding(string $text, ?string $provider): array"})," - Generate embedding with saved settings"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"generateEmbeddingWithCustomConfig(string $text, array $config): array"})," - Generate with custom config"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"testEmbedding(string $provider, array $config, string $testText): array"})," - Test configuration"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"semanticSearch(string $query, int $limit, array $filters): array"})," - Semantic search"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"storeVector(...)"})," - Store embedding in database"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Dependencies"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"LLPhant library for embedding generation"}),"\n",(0,r.jsx)(n.li,{children:"Database connection for vector storage"}),"\n",(0,r.jsx)(n.li,{children:"SettingsService for reading configuration (not for testing)"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Independence"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\u2705 ",(0,r.jsx)(n.strong,{children:"Independent of SOLR"})," - Can operate without search infrastructure"]}),"\n",(0,r.jsxs)(n.li,{children:["\u2705 ",(0,r.jsx)(n.strong,{children:"No chat dependencies"})," - Only handles embeddings"]}),"\n",(0,r.jsxs)(n.li,{children:["\u2705 ",(0,r.jsx)(n.strong,{children:"Standalone testing"})," - Tests don't require settings storage"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"chatservice",children:"ChatService"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Location"}),": ",(0,r.jsx)(n.code,{children:"lib/Service/ChatService.php"})]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Purpose"}),": Handles all LLM chat operations with RAG (Retrieval Augmented Generation)."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Responsibilities"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Process chat messages with context retrieval"}),"\n",(0,r.jsx)(n.li,{children:"Generate AI responses using configured LLM providers"}),"\n",(0,r.jsx)(n.li,{children:"Manage conversation history and summarization"}),"\n",(0,r.jsx)(n.li,{children:"Generate conversation titles automatically"}),"\n",(0,r.jsx)(n.li,{children:"Test LLM chat configurations without saving settings"}),"\n",(0,r.jsx)(n.li,{children:"Handle agent-based context retrieval and filtering"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Provider Support"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"OpenAI: GPT-4, GPT-4o-mini, and other chat models"}),"\n",(0,r.jsx)(n.li,{children:"Fireworks AI: Llama, Mistral, and other open models"}),"\n",(0,r.jsx)(n.li,{children:"Ollama: Local LLM deployments"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"RAG Capabilities"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Semantic search using VectorEmbeddingService"}),"\n",(0,r.jsx)(n.li,{children:"Keyword search using GuzzleSolrService (optional)"}),"\n",(0,r.jsx)(n.li,{children:"Hybrid search combining both approaches"}),"\n",(0,r.jsx)(n.li,{children:"Agent-based filtering and context retrieval"}),"\n",(0,r.jsx)(n.li,{children:"View-based filtering for multi-tenancy"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Key Methods"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"processMessage(int $conversationId, string $userId, string $userMessage): array"})," - Process chat with RAG"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"testChat(string $provider, array $config, string $testMessage): array"})," - Test configuration"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"generateConversationTitle(string $firstMessage): string"})," - Generate title"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"ensureUniqueTitle(string $baseTitle, string $userId, int $agentId): string"})," - Ensure uniqueness"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Dependencies"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"LLPhant library for LLM interactions"}),"\n",(0,r.jsx)(n.li,{children:"VectorEmbeddingService for semantic search"}),"\n",(0,r.jsx)(n.li,{children:"GuzzleSolrService for keyword search (optional)"}),"\n",(0,r.jsx)(n.li,{children:"ConversationMapper, MessageMapper, AgentMapper for data persistence"}),"\n",(0,r.jsx)(n.li,{children:"SettingsService for reading configuration (not for testing)"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Independence"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\u2705 ",(0,r.jsx)(n.strong,{children:"Independent testing"})," - Tests don't require settings storage"]}),"\n",(0,r.jsxs)(n.li,{children:["\u2705 ",(0,r.jsx)(n.strong,{children:"Optional SOLR"})," - Can work without keyword search"]}),"\n",(0,r.jsxs)(n.li,{children:["\u2705 ",(0,r.jsx)(n.strong,{children:"Flexible RAG"})," - Can use semantic-only, keyword-only, or hybrid search"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"settingsservice",children:"SettingsService"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Location"}),": ",(0,r.jsx)(n.code,{children:"lib/Service/SettingsService.php"})]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Purpose"}),": Store and retrieve application settings ONLY. Does NOT contain business logic."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Responsibilities"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Store and retrieve settings from Nextcloud's ",(0,r.jsx)(n.code,{children:"IAppConfig"})]}),"\n",(0,r.jsx)(n.li,{children:"Provide default values for unconfigured settings"}),"\n",(0,r.jsx)(n.li,{children:"Manage settings categories: RBAC, Multitenancy, Retention, SOLR, LLM, Files, Objects"}),"\n",(0,r.jsx)(n.li,{children:"Get available options (groups, users, tenants) for settings UI"}),"\n",(0,r.jsx)(n.li,{children:"Rebase operations (apply default owners/tenants to existing objects)"}),"\n",(0,r.jsx)(n.li,{children:"Cache management statistics and operations"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"What This Service Does NOT Do"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u274c Test LLM connections (use VectorEmbeddingService or ChatService)"}),"\n",(0,r.jsx)(n.li,{children:"\u274c Test SOLR connections (use GuzzleSolrService)"}),"\n",(0,r.jsx)(n.li,{children:"\u274c Generate embeddings (use VectorEmbeddingService)"}),"\n",(0,r.jsx)(n.li,{children:"\u274c Execute chat operations (use ChatService)"}),"\n",(0,r.jsx)(n.li,{children:"\u274c Perform searches (use appropriate search services)"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Settings Categories"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Version"}),": Application name and version information"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"RBAC"}),": Role-based access control configuration"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Multitenancy"}),": Tenant isolation and default tenant settings"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Retention"}),": Data retention policies for objects, logs, trails"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"SOLR"}),": Search engine configuration and connection details"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"LLM"}),": Language model provider configuration (OpenAI, Fireworks, Ollama)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Files"}),": File processing and vectorization settings"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Objects"}),": Object vectorization and metadata settings"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Organisation"}),": Default organisation and auto-creation settings"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Key Methods"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"getSettings(): array"})," - Get all settings with defaults"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"updateSettings(array $data): array"})," - Update all settings"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"getLLMSettingsOnly(): array"})," - Get LLM settings"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"updateLLMSettingsOnly(array $data): array"})," - Update LLM settings"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"getSolrSettingsOnly(): array"})," - Get SOLR settings"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"updateSolrSettingsOnly(array $data): array"})," - Update SOLR settings"]}),"\n",(0,r.jsx)(n.li,{children:"(Similar methods for other setting categories)"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Dependencies"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"IAppConfig for settings storage"}),"\n",(0,r.jsx)(n.li,{children:"IConfig for system configuration"}),"\n",(0,r.jsx)(n.li,{children:"Various mappers for available options (groups, users, tenants)"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Architecture Pattern"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\u2705 ",(0,r.jsx)(n.strong,{children:"Persistence layer only"})," - No business logic"]}),"\n",(0,r.jsxs)(n.li,{children:["\u2705 ",(0,r.jsx)(n.strong,{children:"Default values"})," - Always returns valid configuration"]}),"\n",(0,r.jsxs)(n.li,{children:["\u2705 ",(0,r.jsx)(n.strong,{children:"Validation"})," - Ensures settings have correct types and structures"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"settingscontroller",children:"SettingsController"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Location"}),": ",(0,r.jsx)(n.code,{children:"lib/Controller/SettingsController.php"})]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Purpose"}),": Thin HTTP layer that validates requests and delegates to services."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Responsibilities"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Validate HTTP request parameters"}),"\n",(0,r.jsx)(n.li,{children:"Delegate settings CRUD operations to SettingsService"}),"\n",(0,r.jsx)(n.li,{children:"Delegate LLM testing to VectorEmbeddingService and ChatService"}),"\n",(0,r.jsx)(n.li,{children:"Delegate SOLR testing to GuzzleSolrService"}),"\n",(0,r.jsx)(n.li,{children:"Return appropriate JSONResponse with correct HTTP status codes"}),"\n",(0,r.jsx)(n.li,{children:"Handle HTTP-level concerns (authentication, CSRF)"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Architecture Pattern"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\u2705 ",(0,r.jsx)(n.strong,{children:"Thin controller"})," - Minimal logic, delegates to services"]}),"\n",(0,r.jsxs)(n.li,{children:["\u2705 ",(0,r.jsx)(n.strong,{children:"Validation only"})," - Checks required parameters exist"]}),"\n",(0,r.jsxs)(n.li,{children:["\u2705 ",(0,r.jsx)(n.strong,{children:"Service delegation"})," - Business logic in services"]}),"\n",(0,r.jsxs)(n.li,{children:["\u2705 ",(0,r.jsx)(n.strong,{children:"Error handling"})," - Catches service errors and returns HTTP responses"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"service-interactions",children:"Service Interactions"}),"\n",(0,r.jsx)(n.h3,{id:"testing-llm-embeddings",children:"Testing LLM Embeddings"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"HTTP Request\n    \u2193\nSettingsController::testEmbedding()\n    \u2193 (validates parameters)\nVectorEmbeddingService::testEmbedding()\n    \u2193 (business logic)\nVectorEmbeddingService::generateEmbeddingWithCustomConfig()\n    \u2193 (creates generator)\nLLPhant EmbeddingGenerator\n    \u2193 (API call)\nOpenAI/Fireworks/Ollama API\n"})}),"\n",(0,r.jsx)(n.h3,{id:"testing-llm-chat",children:"Testing LLM Chat"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"HTTP Request\n    \u2193\nSettingsController::testChat()\n    \u2193 (validates parameters)\nChatService::testChat()\n    \u2193 (business logic)\nLLPhant OpenAIChat\n    \u2193 (API call)\nOpenAI/Fireworks/Ollama API\n"})}),"\n",(0,r.jsx)(n.h3,{id:"processing-chat-with-rag",children:"Processing Chat with RAG"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"HTTP Request\n    \u2193\nChatController::processMessage()\n    \u2193\nChatService::processMessage()\n    \u2193 (retrieves context)\nVectorEmbeddingService::semanticSearch()\n    \u2193 (combines with keywords if needed)\nGuzzleSolrService::search() [optional]\n    \u2193 (generates response)\nLLPhant OpenAIChat\n"})}),"\n",(0,r.jsx)(n.h3,{id:"storing-settings",children:"Storing Settings"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"HTTP Request\n    \u2193\nSettingsController::updateLLMSettings()\n    \u2193 (validates parameters)\nSettingsService::updateLLMSettingsOnly()\n    \u2193 (persists to storage)\nIAppConfig::setValueString()\n"})}),"\n",(0,r.jsx)(n.h2,{id:"key-architectural-decisions",children:"Key Architectural Decisions"}),"\n",(0,r.jsx)(n.h3,{id:"1-no-temporary-config-storage",children:"1. No Temporary Config Storage"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Problem"}),": Testing LLM configurations required saving test config, testing, then restoring original."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Solution"}),": Services accept config as parameters for testing, no settings manipulation needed."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"// OLD - Temporary config storage (WRONG)\n$original = $settingsService->getLLMSettings();\n$settingsService->updateLLMSettings($testConfig);\n$result = $service->doSomething();\n$settingsService->updateLLMSettings($original);\n\n// NEW - Direct config passing (CORRECT)\n$result = $service->testWithConfig($testConfig);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"2-service-independence",children:"2. Service Independence"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Problem"}),": Services were reading from inconsistent config keys or environment variables."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Solution"}),": Each service reads from its designated config key or accepts config as parameters."]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["VectorEmbeddingService: Reads from ",(0,r.jsx)(n.code,{children:"vector_embeddings"})," key OR accepts custom config"]}),"\n",(0,r.jsxs)(n.li,{children:["ChatService: Reads from ",(0,r.jsx)(n.code,{children:"llm"})," key OR accepts custom config"]}),"\n",(0,r.jsx)(n.li,{children:"Testing: Always uses custom config (no settings dependency)"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"3-clear-delegation",children:"3. Clear Delegation"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Problem"}),": Controllers contained business logic for testing."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Solution"}),": Controllers validate and delegate, services contain business logic."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"Controller Responsibilities:\n- Validate HTTP parameters\n- Call appropriate service method\n- Return HTTP response\n\nService Responsibilities:\n- Implement business logic\n- Return structured data (arrays)\n- Handle errors with try/catch\n"})}),"\n",(0,r.jsx)(n.h3,{id:"4-solr-and-llm-separation",children:"4. SOLR and LLM Separation"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Problem"}),": LLM services were coupled to SOLR infrastructure."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Solution"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"VectorEmbeddingService is completely independent of SOLR"}),"\n",(0,r.jsx)(n.li,{children:"ChatService optionally uses SOLR for keyword search"}),"\n",(0,r.jsx)(n.li,{children:"Hybrid search is implemented in ChatService, not as a dependency"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"testing-best-practices",children:"Testing Best Practices"}),"\n",(0,r.jsx)(n.h3,{id:"testing-service-methods",children:"Testing Service Methods"}),"\n",(0,r.jsx)(n.p,{children:"Services should be testable without HTTP layer:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"// Good - Service can be tested directly\n$vectorService = new VectorEmbeddingService($db, $settings, $logger);\n$result = $vectorService->testEmbedding('openai', [\n    'apiKey' => 'test-key',\n    'model' => 'text-embedding-3-small'\n], 'Test text');\n\n$this->assertTrue($result['success']);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"testing-controllers",children:"Testing Controllers"}),"\n",(0,r.jsx)(n.p,{children:"Controllers should only validate and delegate:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"// Good - Controller test mocks services\n$mockService = $this->createMock(VectorEmbeddingService::class);\n$mockService->expects($this->once())\n    ->method('testEmbedding')\n    ->willReturn(['success' => true]);\n\n$controller = new SettingsController($mockService, ...);\n$response = $controller->testEmbedding();\n\n$this->assertEquals(200, $response->getStatus());\n"})}),"\n",(0,r.jsx)(n.h2,{id:"summary",children:"Summary"}),"\n",(0,r.jsx)(n.h3,{id:"service-responsibilities",children:"Service Responsibilities"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Service"}),(0,r.jsx)(n.th,{children:"Purpose"}),(0,r.jsx)(n.th,{children:"Tests Its Own"}),(0,r.jsx)(n.th,{children:"Depends On"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"VectorEmbeddingService"})}),(0,r.jsx)(n.td,{children:"Generate and search embeddings"}),(0,r.jsx)(n.td,{children:"\u2705 Yes"}),(0,r.jsx)(n.td,{children:"Database, LLPhant"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"ChatService"})}),(0,r.jsx)(n.td,{children:"LLM chat with RAG"}),(0,r.jsx)(n.td,{children:"\u2705 Yes"}),(0,r.jsx)(n.td,{children:"VectorEmbedding, optional SOLR"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"SettingsService"})}),(0,r.jsx)(n.td,{children:"Store/retrieve settings"}),(0,r.jsx)(n.td,{children:"\u274c No (persistence only)"}),(0,r.jsx)(n.td,{children:"IAppConfig"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"SettingsController"})}),(0,r.jsx)(n.td,{children:"HTTP validation and delegation"}),(0,r.jsx)(n.td,{children:"\u274c No (thin layer)"}),(0,r.jsx)(n.td,{children:"All services"})]})]})]}),"\n",(0,r.jsx)(n.h3,{id:"key-takeaways",children:"Key Takeaways"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"\u2705 Services contain business logic and can test themselves"}),"\n",(0,r.jsx)(n.li,{children:"\u2705 Controllers validate and delegate, no business logic"}),"\n",(0,r.jsx)(n.li,{children:"\u2705 SettingsService only handles persistence, not testing"}),"\n",(0,r.jsx)(n.li,{children:"\u2705 Testing uses custom config parameters, not temporary storage"}),"\n",(0,r.jsx)(n.li,{children:"\u2705 SOLR and LLM are independent, ChatService can optionally combine them"}),"\n",(0,r.jsx)(n.li,{children:"\u2705 Each service has clear, documented responsibilities"}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(a,{...e})}):a(e)}}}]);