# =============================================================================
# NGINX TIMEOUT OPTIMALISATIES VOOR OPENREGISTER IMPORTS
# =============================================================================
# Deze configuratie kan toegevoegd worden aan je nginx server block
# voor optimale performance bij grote file imports

server {
    # ... existing server config ...

    # ====================
    # TIMEOUT SETTINGS
    # ====================
    
    # Backend response timeout - verhoog voor lange imports
    proxy_read_timeout 900s;          # 15 minuten (was waarschijnlijk 60s)
    proxy_connect_timeout 60s;        # Connectie timeout
    proxy_send_timeout 60s;           # Send timeout
    
    # Client timeouts
    client_header_timeout 60s;        # Client header timeout
    client_body_timeout 300s;         # Client body timeout (upload time)
    
    # ====================
    # UPLOAD LIMITS
    # ====================
    
    # Maximum upload grootte voor grote CSV/Excel bestanden
    client_max_body_size 50M;         # Verhoog naar benodigde grootte
    
    # Buffer settings voor grote uploads
    client_body_buffer_size 128k;
    proxy_buffering on;
    proxy_buffer_size 4k;
    proxy_buffers 8 4k;
    proxy_busy_buffers_size 8k;
    
    # ====================
    # OPENREGISTER SPECIFIC
    # ====================
    
    # Specifieke location voor import endpoints
    location ~ ^/index\.php/apps/openregister/api/registers/\d+/import$ {
        # Langere timeout specifiek voor imports
        proxy_read_timeout 1800s;      # 30 minuten voor zeer grote imports
        proxy_send_timeout 300s;
        
        # Grote uploads toestaan
        client_max_body_size 100M;
        
        # PHP upstream forwarding
        fastcgi_pass php-fpm;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
        
        # PHP specifieke timeouts
        fastcgi_read_timeout 1800s;    # 30 minuten
        fastcgi_send_timeout 300s;
    }
    
    # Heartbeat endpoint - snel en lichtgewicht
    location ~ ^/index\.php/apps/openregister/api/heartbeat$ {
        proxy_read_timeout 10s;        # Kort voor heartbeat
        proxy_connect_timeout 5s;
        
        # PHP upstream forwarding
        fastcgi_pass php-fpm;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
        
        fastcgi_read_timeout 10s;
    }
}

# =============================================================================
# ALTERNATIEVE UPSTREAM CONFIGURATIE
# =============================================================================
# Als je een upstream block gebruikt voor PHP-FPM:

upstream php-fpm {
    server unix:/var/run/php/php8.1-fpm.sock;
    # Of: server 127.0.0.1:9000;
    
    # Connection pooling voor performance
    keepalive 32;
}
